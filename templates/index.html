<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÆûÊó∂ËÅäÂ§©ÂÆ§</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-gradient-start: #0a0a0f;
            --bg-gradient-end: #0d1117;
            --container-bg: #010409;
            --container-border: #161b22;
            --header-gradient-start: #161b22;
            --header-gradient-end: #0d1117;
            --header-border: #21262d;
            --text-color: #c9d1d9;
            --text-secondary: #8b949e;
            --accent-color: #58a6ff;
            --input-bg: #0d1117;
            --input-border: #30363d;
            --input-border-focus: #58a6ff;
            --button-bg-start: #238636;
            --button-bg-end: #1a7f37;
            --message-bg: #0d1117;
            --message-user-bg: #1c2128;
            --message-border: #21262d;
            --exit-btn-bg: #21262d;
            --exit-btn-color: #f85149;
            --link-preview-bg: #161b22;
            --link-preview-border: #30363d;
        }
        
        body.light-theme {
            --bg-gradient-start: #f6f8fa;
            --bg-gradient-end: #ffffff;
            --container-bg: #ffffff;
            --container-border: #d0d7de;
            --header-gradient-start: #f6f8fa;
            --header-gradient-end: #ffffff;
            --header-border: #d0d7de;
            --text-color: #24292f;
            --text-secondary: #57606a;
            --accent-color: #0969da;
            --input-bg: #ffffff;
            --input-border: #d0d7de;
            --input-border-focus: #0969da;
            --button-bg-start: #1a7f37;
            --button-bg-end: #2da44e;
            --message-bg: #f6f8fa;
            --message-user-bg: #ddf4ff;
            --message-border: #d0d7de;
            --exit-btn-bg: #ffffff;
            --exit-btn-color: #cf222e;
            --link-preview-bg: #f6f8fa;
            --link-preview-border: #d0d7de;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        .container {
            width: 90%;
            max-width: 800px;
            background: var(--container-bg);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            border: 1px solid var(--container-border);
            transition: all 0.3s ease;
        }
        
        /* ËÅäÂ§©Ê®°Âºè‰∏ãÂÆπÂô®Ëá™ÈÄÇÂ∫î */
        .container.chat-mode {
            width: 95%;
            height: 90vh;
            max-width: none;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, var(--header-gradient-start) 0%, var(--header-gradient-end) 100%);
            padding: 20px;
            position: relative;
            text-align: center;
            border-bottom: 2px solid var(--header-border);
            transition: all 0.3s ease;
        }
        
        .header-content {
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: color 0.3s ease;
        }
        
        .theme-toggle {
            position: fixed;
            right: 20px;
            bottom: 20px;
            padding: 10px;
            background: var(--exit-btn-bg);
            color: var(--text-color);
            border: 1px solid var(--container-border);
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: background 0.3s, color 0.3s, border-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 45px;
            height: 45px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        
        .theme-toggle:hover {
            background: var(--accent-color);
            color: #ffffff;
            border-color: var(--accent-color);
        }
        
        .theme-toggle:active {
            opacity: 0.8;
        }
        
        .room-info {
            font-size: 14px;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        
        .exit-btn {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            padding: 8px 16px;
            background: var(--exit-btn-bg);
            color: var(--exit-btn-color);
            border: 1px solid var(--exit-btn-color);
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: none;
            width: auto;
        }
        
        .exit-btn:hover {
            background: var(--exit-btn-color);
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(248, 81, 73, 0.3);
            transform: translateY(-50%);
        }
        
        .exit-btn:active {
            transform: translateY(-50%);
        }
        
        #login-screen {
            padding: 40px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-size: 14px;
            transition: color 0.3s ease;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
        }
        
        .input-group input:focus {
            border-color: var(--input-border-focus);
        }
        
        button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--button-bg-start) 0%, var(--button-bg-end) 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(35, 134, 54, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        #chat-screen {
            display: none;
            flex: 1;
            flex-direction: row;
            overflow: hidden;
        }
        
        /* ÊàêÂëòÂàóË°®‰æßËæπÊ†è */
        #members-sidebar {
            width: 250px;
            background: var(--container-bg);
            border-right: 1px solid var(--container-border);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        
        .members-header {
            padding: 15px;
            background: var(--header-gradient-start);
            border-bottom: 1px solid var(--header-border);
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .members-count {
            background: var(--accent-color);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .members-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .member-card {
            background: var(--message-bg);
            border: 1px solid var(--message-border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        
        .member-card:hover {
            border-color: var(--accent-color);
            transform: translateX(2px);
        }
        
        .member-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .member-time {
            font-size: 11px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--container-bg);
            transition: background 0.3s ease;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.system {
            background: var(--message-bg);
            color: var(--text-secondary);
            text-align: center;
            font-size: 13px;
            font-style: italic;
            border: 1px solid var(--message-border);
            transition: all 0.3s ease;
        }
        
        .message.user {
            background: var(--message-user-bg);
            border-left: 3px solid var(--accent-color);
            border: 1px solid var(--message-border);
            transition: all 0.3s ease;
        }
        
        .message .username {
            font-weight: bold;
            color: var(--accent-color);
            margin-right: 8px;
            transition: color 0.3s ease;
        }
        
        .message .text {
            color: var(--text-color);
            word-wrap: break-word;
            transition: color 0.3s ease;
        }
        
        .link-preview {
            margin-top: 10px;
            padding: 12px;
            background: var(--link-preview-bg);
            border: 1px solid var(--link-preview-border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .link-preview:hover {
            border-color: var(--accent-color);
        }
        
        .link-preview-title {
            color: var(--accent-color);
            font-weight: bold;
            margin-bottom: 6px;
            font-size: 14px;
            transition: color 0.3s ease;
        }
        
        .link-preview-desc {
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 6px;
            line-height: 1.4;
            transition: color 0.3s ease;
        }
        
        .link-preview-site {
            color: var(--text-secondary);
            font-size: 11px;
            font-style: italic;
            opacity: 0.8;
            transition: color 0.3s ease;
        }
        
        .input-area {
            display: flex;
            padding: 20px;
            gap: 10px;
            background: var(--header-gradient-start);
            border-top: 1px solid var(--header-border);
            transition: all 0.3s ease;
        }
        
        .attach-btn {
            width: 45px;
            padding: 12px;
            background: var(--exit-btn-bg);
            color: var(--text-color);
            border: 1px solid var(--input-border);
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .attach-btn:hover {
            background: var(--accent-color);
            color: #ffffff;
            border-color: var(--accent-color);
        }
        
        /* AIÊåâÈíÆÊ†∑Âºè */
        .ai-btn {
            width: 45px;
            padding: 12px;
            background: var(--exit-btn-bg);
            color: var(--text-color);
            border: 1px solid var(--input-border);
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .ai-btn:hover {
            background: var(--accent-color);
            color: #ffffff;
            border-color: var(--accent-color);
        }
        
        .ai-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }
        
        .ai-btn.active::after {
            content: '';
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            box-shadow: 0 0 10px #4ade80;
        }
        
        /* AIÊ∂àÊÅØÊ†∑Âºè */
        .message.ai {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-left: 3px solid #667eea;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }
        
        .message.ai .username {
            color: #667eea;
        }
        
        /* AIÊµÅÂºèËæìÂá∫Âä®Áîª */
        @keyframes typing {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        .ai-typing-indicator {
            display: inline-block;
            animation: typing 1.5s infinite;
        }
        
        #message-input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
        }
        
        #message-input:focus {
            border-color: var(--input-border-focus);
        }
        
        #send-btn {
            width: 100px;
            padding: 12px;
        }
        
        .file-message {
            background: var(--link-preview-bg);
            border: 1px solid var(--link-preview-border);
            padding: 12px;
            border-radius: 6px;
            margin-top: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-message:hover {
            border-color: var(--accent-color);
        }
        
        .file-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .file-name {
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 4px;
        }
        
        .file-size {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .media-preview {
            margin-top: 10px;
            border-radius: 8px;
            overflow: hidden;
            max-width: 100%;
        }
        
        .media-preview img {
            max-width: 100%;
            max-height: 400px;
            display: block;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .media-preview img:hover {
            transform: scale(1.02);
        }
        
        .media-preview video {
            max-width: 100%;
            max-height: 400px;
            display: block;
            border-radius: 6px;
            background: #000;
        }
        
        .media-preview audio {
            width: 100%;
            margin-top: 8px;
        }
        
        .upload-progress {
            margin-top: 10px;
            padding: 10px;
            background: var(--message-bg);
            border-radius: 6px;
            border: 1px solid var(--message-border);
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--input-border);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--accent-color);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        
        #messages::-webkit-scrollbar {
            width: 8px;
        }
        
        #messages::-webkit-scrollbar-track {
            background: var(--container-bg);
        }
        
        #messages::-webkit-scrollbar-thumb {
            background: var(--input-border);
            border-radius: 4px;
        }
        
        #messages::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color);
        }
        
        /* Á≤òË¥¥ÂõæÁâáÈ¢ÑËßàÊ†∑Âºè */
        .paste-preview-container {
            padding: 10px;
            background: var(--message-bg);
            border: 1px solid var(--input-border);
            border-radius: 6px;
            margin-bottom: 10px;
            display: none;
        }
        
        .paste-preview-container.active {
            display: block;
        }
        
        .paste-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .paste-preview-title {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .paste-preview-close {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: auto;
            transition: color 0.3s;
        }
        
        .paste-preview-close:hover {
            color: var(--exit-btn-color);
            transform: none;
            box-shadow: none;
        }
        
        .paste-preview-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            display: block;
            margin-bottom: 10px;
        }
        
        .paste-preview-actions {
            display: flex;
            gap: 10px;
        }
        
        .paste-preview-btn {
            flex: 1;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .paste-preview-send {
            background: linear-gradient(135deg, var(--button-bg-start) 0%, var(--button-bg-end) 100%);
            color: white;
        }
        
        .paste-preview-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(35, 134, 54, 0.4);
        }
        
        .paste-preview-cancel {
            background: var(--exit-btn-bg);
            color: var(--text-color);
            border: 1px solid var(--input-border);
        }
        
        .paste-preview-cancel:hover {
            background: var(--card-hover);
            border-color: var(--accent-color);
            transform: none;
            box-shadow: none;
        }
        
        /* ÂéÜÂè≤ËÆ∞ÂΩïÊ†∑Âºè */
        .history-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid var(--input-border);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .history-title {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        .clear-history-btn {
            padding: 4px 12px;
            background: var(--exit-btn-bg);
            color: var(--text-secondary);
            border: 1px solid var(--input-border);
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            width: auto;
        }
        
        .clear-history-btn:hover {
            color: var(--exit-btn-color);
            border-color: var(--exit-btn-color);
            transform: none;
            box-shadow: none;
        }
        
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .history-item:hover {
            border-color: var(--accent-color);
            background: var(--message-bg);
        }
        
        .history-item-info {
            flex: 1;
            cursor: pointer;
            min-width: 0;
        }
        
        .history-room {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .history-username {
            font-size: 12px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .history-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
            margin-left: 12px;
            flex-shrink: 0;
        }
        
        .history-time {
            font-size: 11px;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        
        .history-count {
            font-size: 11px;
            padding: 2px 8px;
            background: var(--message-bg);
            border: 1px solid var(--input-border);
            border-radius: 10px;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        
        .history-delete {
            margin-left: 10px;
            padding: 4px 8px;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--input-border);
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
            width: auto;
        }
        
        .history-delete:hover {
            color: var(--exit-btn-color);
            border-color: var(--exit-btn-color);
            background: var(--exit-btn-bg);
            transform: none;
            box-shadow: none;
        }
        
        .history-empty {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
            font-size: 13px;
        }
        
        .history-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .history-list::-webkit-scrollbar-track {
            background: var(--container-bg);
        }
        
        .history-list::-webkit-scrollbar-thumb {
            background: var(--input-border);
            border-radius: 3px;
        }
        
        .members-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .members-list::-webkit-scrollbar-track {
            background: var(--container-bg);
        }
        
        .members-list::-webkit-scrollbar-thumb {
            background: var(--input-border);
            border-radius: 3px;
        }
        
        .members-list::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color);
        }
        
        /* ÂéÜÂè≤ËÆ∞ÂΩïÈù¢ÊùøÊ†∑Âºè */
        #history-sidebar {
            width: 0;
            background: var(--container-bg);
            border-left: 1px solid var(--container-border);
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            overflow: hidden;
        }
        
        #history-sidebar.active {
            width: 350px;
        }
        
        .history-sidebar-header {
            padding: 15px;
            background: var(--header-gradient-start);
            border-bottom: 1px solid var(--header-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .history-sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .history-close-btn {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: auto;
            transition: color 0.3s;
        }
        
        .history-close-btn:hover {
            color: var(--exit-btn-color);
            transform: none;
            box-shadow: none;
        }
        
        .history-filter-tabs {
            display: flex;
            padding: 10px;
            gap: 8px;
            background: var(--message-bg);
            border-bottom: 1px solid var(--message-border);
            overflow-x: auto;
        }
        
        .history-filter-tab {
            padding: 6px 12px;
            background: var(--input-bg);
            color: var(--text-secondary);
            border: 1px solid var(--input-border);
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            width: auto;
        }
        
        .history-filter-tab:hover {
            border-color: var(--accent-color);
            transform: none;
            box-shadow: none;
        }
        
        .history-filter-tab.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        
        .history-messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .history-message {
            margin-bottom: 15px;
            padding: 10px;
            background: var(--message-bg);
            border: 1px solid var(--message-border);
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .history-message:hover {
            border-color: var(--accent-color);
        }
        
        .history-message .username {
            font-weight: bold;
            color: var(--accent-color);
            font-size: 13px;
            margin-bottom: 4px;
        }
        
        .history-message .text {
            color: var(--text-color);
            font-size: 13px;
            word-wrap: break-word;
            margin-bottom: 4px;
        }
        
        .history-message .timestamp {
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        .history-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            font-size: 13px;
        }
        
        .history-loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            font-size: 13px;
        }
        
        .history-messages-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .history-messages-container::-webkit-scrollbar-track {
            background: var(--container-bg);
        }
        
        .history-messages-container::-webkit-scrollbar-thumb {
            background: var(--input-border);
            border-radius: 3px;
        }
        
        .history-messages-container::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color);
        }
        
        /* ÂéÜÂè≤ËÆ∞ÂΩïÊåâÈíÆÊ†∑Âºè */
        .history-toggle-btn {
            width: 45px;
            padding: 12px;
            background: var(--exit-btn-bg);
            color: var(--text-color);
            border: 1px solid var(--input-border);
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .history-toggle-btn:hover {
            background: var(--accent-color);
            color: #ffffff;
            border-color: var(--accent-color);
        }
        
        .history-toggle-btn.active {
            background: var(--accent-color);
            color: #ffffff;
            border-color: var(--accent-color);
        }
    </style>
</head>
<body>
    <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()">
        <span id="theme-icon">‚òÄÔ∏è</span>
    </button>
    
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>üó®Ô∏è ÂÆûÊó∂ËÅäÂ§©ÂÆ§</h1>
                <div class="room-info" id="room-info">Ê¨¢Ëøé‰ΩøÁî®</div>
            </div>
            <button class="exit-btn" id="exit-btn" onclick="exitRoom()">ÈÄÄÂá∫</button>
        </div>
        
        <div id="login-screen">
            <div class="input-group">
                <label for="username">ÊòµÁß∞</label>
                <input type="text" id="username" placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÊòµÁß∞" maxlength="20">
            </div>
            <div class="input-group">
                <label for="room">ÊàøÈó¥Âè∑</label>
                <input type="text" id="room" placeholder="ËØ∑ËæìÂÖ•ÊàøÈó¥Âè∑" maxlength="20">
            </div>
            <button onclick="joinRoom()">ËøõÂÖ•ËÅäÂ§©ÂÆ§</button>
            
            <!-- ÂéÜÂè≤ËÆ∞ÂΩïÂå∫Âüü -->
            <div class="history-section" id="history-section" style="display: none;">
                <div class="history-header">
                    <div class="history-title">üìã ÊúÄËøë‰ΩøÁî®</div>
                    <button class="clear-history-btn" onclick="clearAllHistory()">Ê∏ÖÁ©∫ÂéÜÂè≤</button>
                </div>
                <div class="history-list" id="history-list">
                    <!-- ÂéÜÂè≤ËÆ∞ÂΩïÈ°πÂ∞ÜÈÄöËøá JavaScript Âä®ÊÄÅÊèíÂÖ• -->
                </div>
            </div>
        </div>
        
        <div id="chat-screen">
            <!-- ÊàêÂëòÂàóË°®‰æßËæπÊ†è -->
            <div id="members-sidebar">
                <div class="members-header">
                    <span>üë• ÊàøÈó¥ÊàêÂëò</span>
                    <span class="members-count" id="members-count">0</span>
                </div>
                <div class="members-list" id="members-list">
                    <!-- ÊàêÂëòÂç°ÁâáÂ∞ÜÂä®ÊÄÅÊ∑ªÂä† -->
                </div>
            </div>
            
            <!-- ËÅäÂ§©ÂÜÖÂÆπÂå∫ -->
            <div class="chat-content">
                <div id="messages"></div>
                <div class="input-area" style="flex-direction: column; align-items: stretch;">
                    <!-- Á≤òË¥¥ÂõæÁâáÈ¢ÑËßàÂå∫Âüü -->
                    <div id="paste-preview" class="paste-preview-container">
                        <div class="paste-preview-header">
                            <span class="paste-preview-title">üñºÔ∏è Á≤òË¥¥ÁöÑÂõæÁâá</span>
                            <button class="paste-preview-close" onclick="cancelPastePreview()">‚úï</button>
                        </div>
                        <img id="paste-preview-image" class="paste-preview-image" src="" alt="È¢ÑËßà">
                        <div class="paste-preview-actions">
                            <button class="paste-preview-btn paste-preview-send" onclick="sendPasteImage()">üì§ ÂèëÈÄÅ</button>
                            <button class="paste-preview-btn paste-preview-cancel" onclick="cancelPastePreview()">‚úï ÂèñÊ∂à</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <input type="file" id="file-input" style="display: none;" onchange="handleFileSelect(event)">
                        <button class="attach-btn" onclick="document.getElementById('file-input').click()" title="‰∏ä‰º†Êñá‰ª∂">üìé</button>
                        <button class="ai-btn" id="ai-btn" onclick="toggleAI()" title="AIÂä©Êâã">ü§ñ</button>
                        <button class="ai-btn" id="ai-rename-btn" onclick="renameAI()" title="AIÊîπÂêç" style="display: none; width: auto; padding: 8px 12px; font-size: 13px;">üé≠ AIÊîπÂêç</button>
                        <button class="history-toggle-btn" id="history-toggle-btn" onclick="toggleHistory()" title="ÂéÜÂè≤ËÆ∞ÂΩï">üìú</button>
                        <input type="text" id="message-input" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." onkeypress="handleKeyPress(event)">
                        <button id="send-btn" onclick="sendMessage()">ÂèëÈÄÅ</button>
                    </div>
                </div>
            </div>
            
            <!-- ÂéÜÂè≤ËÆ∞ÂΩï‰æßËæπÊ†è -->
            <div id="history-sidebar">
                <div class="history-sidebar-header">
                    <div class="history-sidebar-title">üìú ÂéÜÂè≤ËÆ∞ÂΩï</div>
                    <button class="history-close-btn" onclick="toggleHistory()">‚úï</button>
                </div>
                <div class="history-filter-tabs">
                    <button class="history-filter-tab active" onclick="filterHistory('all', event)">üí¨ ÂÖ®ÈÉ®</button>
                    <button class="history-filter-tab" onclick="filterHistory('video', event)">üé• ËßÜÈ¢ë</button>
                    <button class="history-filter-tab" onclick="filterHistory('image', event)">üñºÔ∏è ÂõæÁâá</button>
                    <button class="history-filter-tab" onclick="filterHistory('file', event)">üìé Êñá‰ª∂</button>
                </div>
                <div class="history-messages-container" id="history-messages">
                    <div class="history-loading">üîç ÁÇπÂáªÂàÜÁ±ªÊ†áÁ≠æÂä†ËΩΩÂéÜÂè≤Ê∂àÊÅØ...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let socket;
        let currentUsername = '';
        let currentRoom = '';
        let aiEnabled = false; // AIÊåâÈíÆÁä∂ÊÄÅ
        let customAIName = ''; // Ëá™ÂÆö‰πâAIÊòµÁß∞
        let historyPanelOpen = false; // ÂéÜÂè≤ËÆ∞ÂΩïÈù¢ÊùøÁä∂ÊÄÅ
        let currentHistoryFilter = ''; // ÂΩìÂâçÂéÜÂè≤ËÆ∞ÂΩïËøáÊª§Âô®
        
        // ÂéÜÂè≤ËÆ∞ÂΩïÁÆ°ÁêÜ
        const HISTORY_KEY = 'chatroom_history';
        const MAX_HISTORY = 10; // ÊúÄÂ§ö‰øùÂ≠ò10Êù°ËÆ∞ÂΩï
        
        // ‰∏ªÈ¢òÂàáÊç¢ÂäüËÉΩ
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            
            if (body.classList.contains('light-theme')) {
                // ÂàáÊç¢Âà∞Ê∑±Ëâ≤‰∏ªÈ¢ò
                body.classList.remove('light-theme');
                themeIcon.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'dark');
            } else {
                // ÂàáÊç¢Âà∞ÊµÖËâ≤‰∏ªÈ¢ò
                body.classList.add('light-theme');
                themeIcon.textContent = 'üåô';
                localStorage.setItem('theme', 'light');
            }
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÊÅ¢Â§ç‰∏ªÈ¢òËÆæÁΩÆ
        window.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            
            if (savedTheme === 'light') {
                body.classList.add('light-theme');
                themeIcon.textContent = 'üåô';
            } else {
                themeIcon.textContent = '‚òÄÔ∏è';
            }
            
            // Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï
            loadHistory();
        });
        
        // Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï
        function loadHistory() {
            const historyData = getHistoryData();
            const historySection = document.getElementById('history-section');
            const historyList = document.getElementById('history-list');
            
            if (historyData.length === 0) {
                historySection.style.display = 'none';
                return;
            }
            
            historySection.style.display = 'block';
            historyList.innerHTML = '';
            
            historyData.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'history-item';
                itemDiv.innerHTML = `
                    <div class="history-item-info" onclick="fillFormFromHistory(${index})">
                        <div class="history-room">üè† ${escapeHtml(item.room)}</div>
                        <div class="history-username">üë§ ${escapeHtml(item.username)}</div>
                    </div>
                    <div class="history-meta">
                        <div class="history-time">${formatTime(item.lastUsed)}</div>
                        <div class="history-count">‰ΩøÁî® ${item.visitCount} Ê¨°</div>
                    </div>
                    <button class="history-delete" onclick="deleteHistoryItem(${index}, event)">‚úï</button>
                `;
                historyList.appendChild(itemDiv);
            });
        }
        
        // ‰ªéÂéÜÂè≤ËÆ∞ÂΩïÂ°´ÂÖÖË°®Âçï
        function fillFormFromHistory(index) {
            const historyData = getHistoryData();
            if (historyData[index]) {
                document.getElementById('username').value = historyData[index].username;
                document.getElementById('room').value = historyData[index].room;
                // ÂèØ‰ª•ÈÄâÊã©Ëá™Âä®ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
                document.getElementById('username').focus();
            }
        }
        
        // Âà†Èô§ÂçïÊù°ÂéÜÂè≤ËÆ∞ÂΩï
        function deleteHistoryItem(index, event) {
            event.stopPropagation();
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÂéÜÂè≤ËÆ∞ÂΩïÂêóÔºü')) {
                const historyData = getHistoryData();
                historyData.splice(index, 1);
                saveHistoryData(historyData);
                loadHistory();
            }
        }
        
        // Ê∏ÖÁ©∫ÊâÄÊúâÂéÜÂè≤ËÆ∞ÂΩï
        function clearAllHistory() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂéÜÂè≤ËÆ∞ÂΩïÂêóÔºü')) {
                localStorage.removeItem(HISTORY_KEY);
                loadHistory();
            }
        }
        
        // Ëé∑ÂèñÂéÜÂè≤ËÆ∞ÂΩïÊï∞ÊçÆ
        function getHistoryData() {
            try {
                const data = localStorage.getItem(HISTORY_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error('ËØªÂèñÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•:', e);
                return [];
            }
        }
        
        // ‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩïÊï∞ÊçÆ
        function saveHistoryData(data) {
            try {
                localStorage.setItem(HISTORY_KEY, JSON.stringify(data));
            } catch (e) {
                console.error('‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•:', e);
            }
        }
        
        // Ê∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
        function addToHistory(username, room) {
            const historyData = getHistoryData();
            const now = new Date().toISOString();
            
            // Êü•ÊâæÊòØÂê¶Â∑≤Â≠òÂú®Áõ∏ÂêåÁöÑÊàøÈó¥ÂíåÁî®Êà∑ÂêçÁªÑÂêà
            const existingIndex = historyData.findIndex(
                item => item.room === room && item.username === username
            );
            
            if (existingIndex !== -1) {
                // Â∑≤Â≠òÂú®ÔºåÊõ¥Êñ∞Êó∂Èó¥ÂíåËÆøÈóÆÊ¨°Êï∞ÔºåÂπ∂ÁßªÂà∞ÊúÄÂâçÈù¢
                const existing = historyData.splice(existingIndex, 1)[0];
                existing.lastUsed = now;
                existing.visitCount += 1;
                historyData.unshift(existing);
            } else {
                // ‰∏çÂ≠òÂú®ÔºåÊ∑ªÂä†Êñ∞ËÆ∞ÂΩïÂà∞ÊúÄÂâçÈù¢
                historyData.unshift({
                    username: username,
                    room: room,
                    lastUsed: now,
                    visitCount: 1
                });
            }
            
            // ÈôêÂà∂ÂéÜÂè≤ËÆ∞ÂΩïÊï∞Èáè
            if (historyData.length > MAX_HISTORY) {
                historyData.splice(MAX_HISTORY);
            }
            
            saveHistoryData(historyData);
        }
        
        // Ê†ºÂºèÂåñÊó∂Èó¥ÊòæÁ§∫
        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'ÂàöÂàö';
            if (minutes < 60) return `${minutes}ÂàÜÈíüÂâç`;
            if (hours < 24) return `${hours}Â∞èÊó∂Ââç`;
            if (days < 7) return `${days}Â§©Ââç`;
            
            return date.toLocaleDateString('zh-CN', {
                month: '2-digit',
                day: '2-digit'
            });
        }
        
        function joinRoom() {
            const username = document.getElementById('username').value.trim();
            const room = document.getElementById('room').value.trim();
            
            if (!username || !room) {
                alert('ËØ∑ËæìÂÖ•ÊòµÁß∞ÂíåÊàøÈó¥Âè∑');
                return;
            }
            
            currentUsername = username;
            currentRoom = room;
            
            // ‰øùÂ≠òÂà∞ÂéÜÂè≤ËÆ∞ÂΩï
            addToHistory(username, room);
            
            // ËøûÊé•Socket.IO
            socket = io();
            
            // ÁõëÂê¨ËøûÊé•‰∫ã‰ª∂
            socket.on('connect', function() {
                // ËøûÊé•ÊàêÂäüÂêéÂä†ÂÖ•ÊàøÈó¥
                socket.emit('join', {
                    username: username,
                    room: room
                });
            });
            // ÁõëÂê¨Ê∂àÊÅØ
            socket.on('message', function(data) {
                displayMessage(data);
                // Â¶ÇÊûúÂéÜÂè≤ËÆ∞ÂΩïÈù¢ÊùøÊâìÂºÄÔºå‰πüÂ∞ÜÊ∂àÊÅØÊ∑ªÂä†Âà∞ÂéÜÂè≤Èù¢Êùø
                if (historyPanelOpen && shouldShowInHistory(data, currentHistoryFilter)) {
                    addMessageToHistory(data);
                }
            });
            
            // ÁõëÂê¨ÈìæÊé•È¢ÑËßàÊõ¥Êñ∞
            socket.on('link_preview_update', function(data) {
                updateLinkPreview(data.message_id, data.link_preview);
            });
            
            // ÁõëÂê¨AIÂìçÂ∫î‰∫ã‰ª∂
            socket.on('ai_response_start', function(data) {
                handleAIResponseStart(data);
            });
            
            socket.on('ai_response_chunk', function(data) {
                handleAIResponseChunk(data);
            });
            
            socket.on('ai_response_end', function(data) {
                handleAIResponseEnd(data);
            });
            
            socket.on('ai_response_error', function(data) {
                handleAIResponseError(data);
            });

            // ÁõëÂê¨AIÊ∑±Â∫¶ÊÄùËÄÉÊµÅ‰∫ã‰ª∂
            socket.on('ai_reasoning_chunk', function(data) {
                handleAIReasoningChunk(data);
            });

            socket.on('ai_reasoning_end', function(data) {
                handleAIReasoningEnd(data);
            });
            
            // ÁõëÂê¨ÊàøÈó¥Ë¢´Ëß£Êï£ÈÄöÁü•
            socket.on('room_disbanded', function(data) {
                // ÊòæÁ§∫Á≥ªÁªüÊ∂àÊÅØ
                displayMessage({
                    username: 'Á≥ªÁªü',
                    message: data.message,
                    type: 'system',
                    timestamp: new Date().toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    }).replace(/\//g, '-')
                });
                
                // ÂºπÁ™óÊèêÁ§∫ÔºåÁÇπÂáªÁ°ÆÂÆöÂêéËøîÂõû‰∏ªÈ°µ
                alert(data.message);
                
                // Êñ≠ÂºÄËøûÊé•Âπ∂ËøîÂõû‰∏ªÈ°µ
                if (socket) {
                    socket.disconnect();
                }
                
                // Ê∏ÖÁ©∫Ê∂àÊÅØ
                document.getElementById('messages').innerHTML = '';
                
                // Ê∏ÖÁ©∫ÊàêÂëòÂàóË°®
                document.getElementById('members-list').innerHTML = '';
                document.getElementById('members-count').textContent = '0';
                
                // ÈáçÁΩÆAIÊåâÈíÆ
                aiEnabled = false;
                customAIName = '';
                const aiBtn = document.getElementById('ai-btn');
                const renameBtn = document.getElementById('ai-rename-btn');
                if (aiBtn) {
                    aiBtn.classList.remove('active');
                    aiBtn.title = 'AIÂä©Êâã';
                }
                if (renameBtn) {
                    renameBtn.style.display = 'none';
                }
                
                // ÈáçÁΩÆËæìÂÖ•Ê°Ü
                document.getElementById('username').value = '';
                document.getElementById('room').value = '';
                
                // ÂàáÊç¢ÂõûÁôªÂΩïÁïåÈù¢
                document.getElementById('chat-screen').style.display = 'none';
                document.getElementById('login-screen').style.display = 'block';
                document.getElementById('exit-btn').style.display = 'none';
                document.getElementById('room-info').textContent = 'Ê¨¢Ëøé‰ΩøÁî®';
                
                // ÁßªÈô§ËÅäÂ§©Ê®°ÂºèÁ±ªÔºåÊÅ¢Â§çÂéüÂßãÂ∞∫ÂØ∏
                document.querySelector('.container').classList.remove('chat-mode');
                
                // ÈáçÁΩÆÂèòÈáè
                currentUsername = '';
                currentRoom = '';
            });
            
            // ÁõëÂê¨ÂéÜÂè≤Ê∂àÊÅØÔºà‰øùÁïô‰ΩÜ‰∏çÂÜçËá™Âä®ÊòæÁ§∫Ôºâ
            socket.on('history_messages', function(data) {
                // ‰∏çÂÜçËá™Âä®ÊòæÁ§∫ÂéÜÂè≤Ê∂àÊÅØ
            });
            
            // ÁõëÂê¨ÊàøÈó¥ÂéÜÂè≤ËÆ∞ÂΩïÂìçÂ∫î
            socket.on('room_history_response', function(data) {
                handleHistoryResponse(data);
            });
            
            // ÁõëÂê¨ÊàøÈó¥‰ø°ÊÅØ
            socket.on('room_info', function(data) {
                // Êõ¥Êñ∞Â§¥ÈÉ®ÊàøÈó¥‰ø°ÊÅØ
                document.getElementById('room-info').textContent = 
                    `ÊàøÈó¥: ${currentRoom} | Âú®Á∫ø‰∫∫Êï∞: ${data.count}`;
                
                // Êõ¥Êñ∞ÊàêÂëòÂàóË°®
                updateMembersList(data.members_detail || []);
            });
            // ÂàáÊç¢Âà∞ËÅäÂ§©ÁïåÈù¢
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'flex';
            document.getElementById('exit-btn').style.display = 'block';
            
            // Ê∑ªÂä†ËÅäÂ§©Ê®°ÂºèÁ±ªÔºåËÆ©ÂÆπÂô®Ëá™ÈÄÇÂ∫î
            document.querySelector('.container').classList.add('chat-mode');
            
            // ÂêØÁî®Á≤òË¥¥‰∏ä‰º†ÂäüËÉΩ
            enablePasteUpload();
        }
        
        // Êõ¥Êñ∞ÊàêÂëòÂàóË°®
        function updateMembersList(membersDetail) {
            const membersList = document.getElementById('members-list');
            const membersCount = document.getElementById('members-count');
            
            // Êõ¥Êñ∞ÊàêÂëòÊï∞
            membersCount.textContent = membersDetail.length;
            
            // Ê∏ÖÁ©∫ÂàóË°®
            membersList.innerHTML = '';
            
            // Ê∑ªÂä†ÊàêÂëòÂç°Áâá
            membersDetail.forEach(function(member) {
                const memberCard = document.createElement('div');
                memberCard.className = 'member-card';
                
                // Âà§Êñ≠ÊòØÂê¶ÊòØÂΩìÂâçÁî®Êà∑
                const isCurrentUser = member.username === currentUsername;
                const userIndicator = isCurrentUser ? ' (Êàë)' : '';
                
                memberCard.innerHTML = `
                    <div class="member-name">
                        <span>üë§</span>
                        <span>${escapeHtml(member.username)}${userIndicator}</span>
                    </div>
                    <div class="member-time">
                        <span>üïí</span>
                        <span>${member.join_time}</span>
                    </div>
                `;
                
                membersList.appendChild(memberCard);
            });
        }
        
        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            socket.emit('send_message', {
                username: currentUsername,
                room: currentRoom,
                message: message,
                ai_enabled: aiEnabled,
                custom_ai_name: customAIName || null
            });
            
            input.value = '';
            input.focus();
        }
        
        // ÂàáÊç¢AIÂäüËÉΩ
        function toggleAI() {
            const aiBtn = document.getElementById('ai-btn');
            const renameBtn = document.getElementById('ai-rename-btn');
            
            aiEnabled = !aiEnabled;
            
            if (aiEnabled) {
                aiBtn.classList.add('active');
                renameBtn.style.display = 'flex';
                updateAIButtonTitle();
            } else {
                aiBtn.classList.remove('active');
                renameBtn.style.display = 'none';
                aiBtn.title = 'AIÂä©Êâã';
            }
        }
        
        // AIÊîπÂêçÂäüËÉΩ
        function renameAI() {
            const currentName = customAIName || 'ÈªòËÆ§';
            const name = prompt(`ÂΩìÂâçÊòµÁß∞: ${currentName}\n\nËØ∑ËæìÂÖ•Êñ∞ÁöÑAIÂä©ÊâãÊòµÁß∞ÔºàÁïôÁ©∫ÊÅ¢Â§çÈªòËÆ§Ôºâ:`, customAIName);
            
            if (name !== null) { // Áî®Êà∑Ê≤°ÊúâÂèñÊ∂à
                customAIName = name.trim();
                updateAIButtonTitle();
            }
        }
        
        // Êõ¥Êñ∞AIÊåâÈíÆÊèêÁ§∫
        function updateAIButtonTitle() {
            const aiBtn = document.getElementById('ai-btn');
            const displayName = customAIName || 'ÈªòËÆ§';
            aiBtn.title = `AIÂä©ÊâãÔºàÂ∑≤ÂêØÁî®Ôºâ - ÊòµÁß∞: ${displayName}`;
        }
        
        // =========================
        // ÂéÜÂè≤ËÆ∞ÂΩïÂäüËÉΩ
        // =========================
        
        // ÂàáÊç¢ÂéÜÂè≤ËÆ∞ÂΩïÈù¢Êùø
        function toggleHistory() {
            console.log('toggleHistory Ë¢´Ë∞ÉÁî®, ÂΩìÂâçÁä∂ÊÄÅ:', historyPanelOpen);
            const historySidebar = document.getElementById('history-sidebar');
            const historyBtn = document.getElementById('history-toggle-btn');
            
            if (!historySidebar || !historyBtn) {
                console.error('ÂéÜÂè≤ËÆ∞ÂΩïÂÖÉÁ¥†Êú™ÊâæÂà∞');
                return;
            }
            
            historyPanelOpen = !historyPanelOpen;
            
            if (historyPanelOpen) {
                historySidebar.classList.add('active');
                historyBtn.classList.add('active');
                // È¶ñÊ¨°ÊâìÂºÄÊó∂Ëá™Âä®Âä†ËΩΩÂÖ®ÈÉ®ÂéÜÂè≤
                if (!currentHistoryFilter) {
                    console.log('È¶ñÊ¨°ÊâìÂºÄÔºåÂä†ËΩΩÂÖ®ÈÉ®ÂéÜÂè≤');
                    filterHistory('all', null);
                }
            } else {
                historySidebar.classList.remove('active');
                historyBtn.classList.remove('active');
            }
        }
        
        // ËøáÊª§ÂéÜÂè≤ËÆ∞ÂΩï
        function filterHistory(type, event) {
            currentHistoryFilter = type;
            
            // Êõ¥Êñ∞Ê†áÁ≠æÊ†∑Âºè
            const tabs = document.querySelectorAll('.history-filter-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâeventÔºåÊâãÂä®Êü•ÊâæÂØπÂ∫îÁöÑtab
                tabs.forEach(tab => {
                    const tabText = tab.textContent.trim();
                    if ((type === 'all' && tabText.includes('ÂÖ®ÈÉ®')) ||
                        (type === 'video' && tabText.includes('ËßÜÈ¢ë')) ||
                        (type === 'image' && tabText.includes('ÂõæÁâá')) ||
                        (type === 'file' && tabText.includes('Êñá‰ª∂'))) {
                        tab.classList.add('active');
                    }
                });
            }
            
            // ÊòæÁ§∫Âä†ËΩΩ‰∏≠
            const historyMessages = document.getElementById('history-messages');
            historyMessages.innerHTML = '<div class="history-loading">üîç Âä†ËΩΩ‰∏≠...</div>';
            
            // ËØ∑Ê±ÇÂéÜÂè≤Ê∂àÊÅØ
            if (socket && currentRoom) {
                socket.emit('get_room_history', {
                    room: currentRoom,
                    filter: type
                });
            }
        }
        
        // Â§ÑÁêÜÂéÜÂè≤ËÆ∞ÂΩïÂìçÂ∫î
        function handleHistoryResponse(data) {
            const historyMessages = document.getElementById('history-messages');
            
            if (!data.success) {
                historyMessages.innerHTML = `<div class="history-empty">‚ùå Âä†ËΩΩÂ§±Ë¥•: ${data.error || 'Êú™Áü•ÈîôËØØ'}</div>`;
                return;
            }
            
            if (data.messages.length === 0) {
                let emptyText = 'üìã ÊöÇÊó†ÂéÜÂè≤Ê∂àÊÅØ';
                if (data.filter === 'video') {
                    emptyText = 'üé• ÊöÇÊó†ËßÜÈ¢ëÊ∂àÊÅØ';
                } else if (data.filter === 'image') {
                    emptyText = 'üñºÔ∏è ÊöÇÊó†ÂõæÁâáÊ∂àÊÅØ';
                } else if (data.filter === 'file') {
                    emptyText = 'üìé ÊöÇÊó†Êñá‰ª∂Ê∂àÊÅØ';
                }
                historyMessages.innerHTML = `<div class="history-empty">${emptyText}</div>`;
                return;
            }
            
            // Ê∏ÖÁ©∫Âπ∂ÊòæÁ§∫ÂéÜÂè≤Ê∂àÊÅØ
            historyMessages.innerHTML = '';
            
            data.messages.forEach(function(msg) {
                addMessageToHistory(msg);
            });
            
            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            historyMessages.scrollTop = historyMessages.scrollHeight;
        }
        
        // Âà§Êñ≠Ê∂àÊÅØÊòØÂê¶Â∫îËØ•ÊòæÁ§∫Âú®ÂéÜÂè≤ËÆ∞ÂΩï‰∏≠
        function shouldShowInHistory(msg, filterType) {
            if (filterType === 'all') {
                return true;
            } else if (filterType === 'video') {
                return msg.file_info && msg.file_info.file_type === 'video';
            } else if (filterType === 'image') {
                return msg.file_info && msg.file_info.file_type === 'image';
            } else if (filterType === 'file') {
                return msg.file_info !== undefined;
            }
            return false;
        }
        
        // Ê∑ªÂä†Ê∂àÊÅØÂà∞ÂéÜÂè≤Èù¢Êùø
        function addMessageToHistory(msg) {
            const historyMessages = document.getElementById('history-messages');
            if (!historyMessages) return;
            
            // Ê∏ÖÁ©∫Á©∫Áä∂ÊÄÅÊèêÁ§∫
            const emptyDiv = historyMessages.querySelector('.history-empty');
            if (emptyDiv) {
                emptyDiv.remove();
            }
            
            const historyMsgDiv = document.createElement('div');
            historyMsgDiv.className = 'history-message';
            
            if (msg.type === 'system') {
                historyMsgDiv.innerHTML = `
                    <div class="text" style="text-align: center; font-style: italic;">${escapeHtml(msg.message)}</div>
                    <div class="timestamp">${msg.timestamp || ''}</div>
                `;
            } else if (msg.type === 'file' || msg.file_info) {
                // Êñá‰ª∂Ê∂àÊÅØ
                const fileInfo = msg.file_info;
                let filePreview = '';
                
                if (fileInfo && fileInfo.file_type === 'image') {
                    filePreview = `
                        <div class="media-preview" style="margin-top: 8px;">
                            <img src="${fileInfo.download_url}" alt="${escapeHtml(fileInfo.original_filename || fileInfo.filename)}" 
                                 style="max-width: 100%; max-height: 200px; border-radius: 6px; cursor: pointer;"
                                 onclick="window.open('${fileInfo.download_url}', '_blank')">
                        </div>
                    `;
                } else if (fileInfo && fileInfo.file_type === 'video') {
                    filePreview = `
                        <div class="media-preview" style="margin-top: 8px;">
                            <video controls style="max-width: 100%; max-height: 200px; border-radius: 6px;">
                                <source src="${fileInfo.download_url}" type="video/mp4">
                            </video>
                        </div>
                    `;
                } else if (fileInfo) {
                    filePreview = `
                        <div style="margin-top: 8px; padding: 8px; background: var(--input-bg); border-radius: 6px; cursor: pointer;"
                             onclick="window.open('${fileInfo.download_url}', '_blank')">
                            <div style="font-size: 12px; color: var(--accent-color);">üìé ${escapeHtml(fileInfo.original_filename || fileInfo.filename)}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">${fileInfo.size}</div>
                        </div>
                    `;
                }
                
                historyMsgDiv.innerHTML = `
                    <div class="username">${escapeHtml(msg.username)}</div>
                    <div class="text">${escapeHtml(msg.message)}</div>
                    ${filePreview}
                    <div class="timestamp">${msg.timestamp || ''}</div>
                `;
            } else {
                // ÊôÆÈÄöÊ∂àÊÅØ
                const messageText = escapeHtml(msg.message);
                const linkedText = messageText.replace(
                    /(https?:\/\/[^\s]+)/g,
                    '<a href="$1" target="_blank" style="color: var(--accent-color); text-decoration: underline;">$1</a>'
                );
                
                historyMsgDiv.innerHTML = `
                    <div class="username">${escapeHtml(msg.username)}</div>
                    <div class="text">${linkedText}</div>
                    <div class="timestamp">${msg.timestamp || ''}</div>
                `;
            }
            
            historyMessages.appendChild(historyMsgDiv);
            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            historyMessages.scrollTop = historyMessages.scrollHeight;
        }
        
        // Â§ÑÁêÜAIÂìçÂ∫îÂºÄÂßã
        function handleAIResponseStart(data) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai';
            messageDiv.setAttribute('data-message-id', data.message_id);
            // ËÆ∞ÂΩïÊòØÂê¶ÊîØÊåÅÊ∑±Â∫¶ÊÄùËÄÉÔºå‰æõÁªìÊùüÊó∂Âà§Êñ≠ÊòØÂê¶ÊòæÁ§∫ÊèêÁ§∫
            messageDiv.setAttribute('data-supports-reasoning', data.supports_reasoning ? '1' : '0');
            
            // ‰ΩøÁî®‰ªéÊúçÂä°Âô®ËøîÂõûÁöÑAIÊòµÁß∞
            const aiName = data.ai_name || 'AIÂä©Êâã';
            const indicatorText = data.supports_reasoning ? 'Ê≠£Âú®ÊÄùËÄÉ...' : 'ÂõûÁ≠î‰∏≠‚Ä¶';
            const indicatorStyle = data.supports_reasoning ? '' : 'style="animation:none;text-decoration:none;color: var(--text-secondary); font-size: 12px;"';
            
            const messageContent = `
                <span class="username">${escapeHtml(aiName)}:</span>
                <span class="text" id="ai-text-${data.message_id}">
                    <span class="ai-typing-indicator" id="ai-indicator-${data.message_id}" ${indicatorStyle}>${indicatorText}</span>
                </span>
                <br/>
                <div id="ai-reasoning-${data.message_id}" style="display:none; white-space: pre-wrap; color: var(--text-secondary); border-left: 3px solid var(--border-color); margin-top: 6px; padding-left: 8px;"></div>
                <br/>
                <div class="ai-content" id="ai-content-${data.message_id}"></div>
                <div class="timestamp" style="font-size: 11px; color: var(--text-secondary); margin-top: 6px;">${data.timestamp}</div>
            `;
            
            messageDiv.innerHTML = messageContent;
            // Â¶ÇÊûúÊîØÊåÅÊ∑±Â∫¶ÊÄùËÄÉÔºöËÆ©‚ÄúÊ≠£Âú®ÊÄùËÄÉ...‚ÄùÂèØÁÇπÂáª‰ª•Â±ïÂºÄ/Êî∂Ëµ∑Êé®ÁêÜÂÜÖÂÆπ
            try {
                if (data.supports_reasoning) {
                    const indicator = messageDiv.querySelector(`#ai-indicator-${data.message_id}`);
                    const reasonDiv = messageDiv.querySelector(`#ai-reasoning-${data.message_id}`);
                    if (indicator) {
                        indicator.style.cursor = 'pointer';
                        indicator.title = 'ÁÇπÂáªÊü•ÁúãÊÄùËÄÉËøáÁ®ã';
                        indicator.onclick = function() { toggleReason(data.message_id); };
                    }
                    // ÈªòËÆ§‰øùÊåÅÈöêËóèÔºåÁî®Êà∑ÁÇπÂáªÂêéÊâçÊòæÁ§∫
                }
            } catch (e) { /* ÂøΩÁï•Ê∏≤ÊüìÊåâÈíÆÂ§±Ë¥• */ }
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // Â§ÑÁêÜAIÊµÅÂºèÂìçÂ∫îÂùó
        function handleAIResponseChunk(data) {
            const container = document.getElementById(`ai-text-${data.message_id}`);
            if (container) {
                // ‰øùÁïô‚ÄúÊ≠£Âú®ÊÄùËÄÉ‚Äù‰∏∫Á¨¨‰∏ÄË°åÔºå‰∏ç‰øÆÊîπÊñáÊ°à
                
                // ËøΩÂä†Êñ∞ÂÜÖÂÆπÂà∞Áã¨Á´ãÂÜÖÂÆπÂÆπÂô®
                const contentElem = document.getElementById(`ai-content-${data.message_id}`);
                if (contentElem) {
                    contentElem.textContent += data.content;
                }
                
                // ÊªöÂä®Âà∞Â∫ïÈÉ®
                const messagesDiv = document.getElementById('messages');
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }
        
        // Â§ÑÁêÜAIÂìçÂ∫îÁªìÊùü
        function handleAIResponseEnd(data) {
            const textElem = document.getElementById(`ai-text-${data.message_id}`);
            if (textElem) {
                // ÁßªÈô§IDÔºåÈò≤Ê≠¢Ë¢´ÂÜçÊ¨°Êõ¥Êñ∞
                textElem.id = '';
            }
            // ÊÄùËÄÉÁªìÊùüÔºöÊõ¥Êñ∞ÊåáÁ§∫ÊñáÊ°à‰∏∫‚ÄúÊÄùËÄÉÂÆåÊàê‚ÄùÔºåÂπ∂ÂèñÊ∂àÈó™ÁÉÅÊïàÊûú‰∏é‰∏ãÂàíÁ∫ø
            const indicator = document.getElementById(`ai-indicator-${data.message_id}`);
            if (indicator) {
                const container = indicator.closest('.message.ai');
                const supports = container && container.getAttribute('data-supports-reasoning') === '1';
                if (supports) {
                    // ÊîØÊåÅÊé®ÁêÜÊ®°ÂûãÔºöÊòæÁ§∫‚ÄúÊÄùËÄÉÂÆåÊàê‚Äù‰∏éÂèØÁÇπÂáªÊèêÁ§∫
                    indicator.textContent = 'ÊÄùËÄÉÂÆåÊàê';
                    indicator.style.animation = 'none';
                    indicator.classList.remove('ai-typing-indicator');
                    indicator.style.textDecoration = 'none';
                    const existingHint = document.getElementById(`ai-reason-hint-${data.message_id}`);
                    if (!existingHint) {
                        const hint = document.createElement('span');
                        hint.id = `ai-reason-hint-${data.message_id}`;
                        hint.textContent = 'ÁÇπÂáªÊü•ÁúãÊÄùËÄÉÂÜÖÂÆπ';
                        hint.style.color = 'var(--text-secondary)';
                        hint.style.fontSize = '11px';
                        hint.style.marginLeft = '8px';
                        hint.style.cursor = 'pointer';
                        hint.title = 'ÁÇπÂáªÂ±ïÂºÄ/Êî∂Ëµ∑ÊÄùËÄÉËøáÁ®ã';
                        hint.onclick = function() { toggleReason(data.message_id); };
                        const parent = indicator.parentElement;
                        if (parent) parent.appendChild(hint);
                    }
                } else {
                    // ÈùûÊé®ÁêÜÊ®°ÂûãÔºö‰∏çÊòæÁ§∫‚ÄúÊÄùËÄÉÂÆåÊàê‚ÄùÔºåÁßªÈô§ÊåáÁ§∫‰∏éÊé®ÁêÜÂÆπÂô®
                    const reasonDiv = document.getElementById(`ai-reasoning-${data.message_id}`);
                    const existingHint = document.getElementById(`ai-reason-hint-${data.message_id}`);
                    if (existingHint) existingHint.remove();
                    if (reasonDiv) reasonDiv.remove();
                    indicator.remove();
                }
            }
        }
        
        // Â§ÑÁêÜAIÂìçÂ∫îÈîôËØØ
        function handleAIResponseError(data) {
            const textElem = document.getElementById(`ai-text-${data.message_id}`);
            if (textElem) {
                textElem.innerHTML = `<span style="color: var(--exit-btn-color);">‚ùå ${data.error}</span>`;
                textElem.id = '';
            }
        }

        // Êü•Áúã/ÈöêËóèÊÄùËÄÉËøáÁ®ã
        function toggleReason(messageId) {
            const div = document.getElementById(`ai-reasoning-${messageId}`);
            if (!div) return;
            div.style.display = (div.style.display === 'none' ? 'block' : 'none');
        }

        // Â§ÑÁêÜAIÊé®ÁêÜÊµÅ‰∫ã‰ª∂ÔºàÊ∑±Â∫¶ÊÄùËÄÉÂÜÖÂÆπÔºâ
        function handleAIReasoningChunk(data) {
            const div = document.getElementById(`ai-reasoning-${data.message_id}`);
            if (!div) return;
            div.textContent += data.content;
        }

        function handleAIReasoningEnd(data) {
            const div = document.getElementById(`ai-reasoning-${data.message_id}`);
            if (!div) return;
            // ÁªìÊùüÂèØÈÄâÔºö‰∏çÂÅöÈ¢ùÂ§ñÂ§ÑÁêÜÔºåÂÜÖÂÆπÂ∑≤Á¥ØËÆ°
        }
        
        function displayMessage(data, isHistory = false) {
            console.log('ÊòæÁ§∫Ê∂àÊÅØ:', data); // Ë∞ÉËØïÊó•Âøó
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${data.type}`;
            
            // ‰∏∫Ê∂àÊÅØÊ∑ªÂä†ÂîØ‰∏ÄIDÂ±ûÊÄß
            if (data.message_id) {
                messageDiv.setAttribute('data-message-id', data.message_id);
            }
            
            if (data.type === 'system') {
                messageDiv.textContent = data.message;
                // Â¶ÇÊûúÊúâÊó∂Èó¥Êà≥,Ê∑ªÂä†Êó∂Èó¥ÊòæÁ§∫
                if (data.timestamp) {
                    const timeSpan = document.createElement('span');
                    timeSpan.style.fontSize = '11px';
                    timeSpan.style.marginLeft = '8px';
                    timeSpan.style.color = '#6e7681';
                    timeSpan.textContent = data.timestamp;
                    messageDiv.appendChild(timeSpan);
                }
            } else if (data.type === 'file') {
                // Êñá‰ª∂Ê∂àÊÅØ
                let timestampHTML = '';
                if (data.timestamp) {
                    timestampHTML = `<span style="font-size: 11px; color: #6e7681; margin-left: 10px;">${data.timestamp}</span>`;
                }
                
                messageDiv.innerHTML = `
                    <span class="username">${escapeHtml(data.username)}:</span>
                    <span class="text">${escapeHtml(data.message)}</span>
                    ${timestampHTML}
                `;
                
                // Ê∑ªÂä†Êñá‰ª∂Âç°ÁâáÊàñÂ™í‰ΩìÈ¢ÑËßà
                if (data.file_info) {
                    addFilePreview(messageDiv, data.file_info);
                }
            } else {
                // Â∞ÜURLËΩ¨Êç¢‰∏∫ÂèØÁÇπÂáªÁöÑÈìæÊé•
                const messageText = escapeHtml(data.message);
                const linkedText = messageText.replace(
                    /(https?:\/\/[^\s]+)/g,
                    '<a href="$1" target="_blank" style="color: #58a6ff; text-decoration: underline;">$1</a>'
                );
                
                let timestampHTML = '';
                if (data.timestamp) {
                    timestampHTML = `<span style="font-size: 11px; color: #6e7681; margin-left: 10px;">${data.timestamp}</span>`;
                }
                
                messageDiv.innerHTML = `
                    <span class="username">${escapeHtml(data.username)}:</span>
                    <span class="text">${linkedText}</span>
                    ${timestampHTML}
                `;
                
                // Â¶ÇÊûúÊúâÈìæÊé•È¢ÑËßà,Ê∑ªÂä†È¢ÑËßàÂç°Áâá
                if (data.link_preview) {
                    addPreviewCard(messageDiv, data.link_preview);
                }
            }
            
            messagesDiv.appendChild(messageDiv);
            
            // Âè™ÊúâÈùûÂéÜÂè≤Ê∂àÊÅØÊâçËá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
            if (!isHistory) {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }
        
        function addPreviewCard(messageDiv, preview) {
            // Ê∑ªÂä†ÈìæÊé•È¢ÑËßàÂç°ÁâáÂà∞Ê∂àÊÅØÂÖÉÁ¥†
            const previewDiv = document.createElement('div');
            previewDiv.className = 'link-preview';
            previewDiv.onclick = () => window.open(preview.url, '_blank');
            
            let previewHTML = '';
            if (preview.title) {
                previewHTML += `<div class="link-preview-title">${escapeHtml(preview.title)}</div>`;
            }
            if (preview.description) {
                previewHTML += `<div class="link-preview-desc">${escapeHtml(preview.description)}</div>`;
            }
            if (preview.site_name) {
                previewHTML += `<div class="link-preview-site">üìé ${escapeHtml(preview.site_name)}</div>`;
            }
            
            previewDiv.innerHTML = previewHTML;
            messageDiv.appendChild(previewDiv);
        }
        
        function updateLinkPreview(messageId, linkPreview) {
            // Êõ¥Êñ∞Ê∂àÊÅØÁöÑÈìæÊé•È¢ÑËßà
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageDiv && linkPreview) {
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊúâÈ¢ÑËßàÂç°Áâá
                const existingPreview = messageDiv.querySelector('.link-preview');
                if (!existingPreview) {
                    addPreviewCard(messageDiv, linkPreview);
                }
            }
        }
        
        // Ê∑ªÂä†Êñá‰ª∂È¢ÑËßàÔºàÂõæÁâá/ËßÜÈ¢ë/Èü≥È¢ëÊàñÊôÆÈÄöÊñá‰ª∂Ôºâ
        function addFilePreview(messageDiv, fileInfo) {
            const filename = fileInfo.filename.toLowerCase();
            const downloadUrl = fileInfo.download_url;
            
            // ÂõæÁâáÊñá‰ª∂Ê†ºÂºè
            const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'];
            // ËßÜÈ¢ëÊñá‰ª∂Ê†ºÂºè
            const videoExts = ['mp4', 'webm', 'ogg', 'mov', 'avi', 'mkv'];
            // Èü≥È¢ëÊñá‰ª∂Ê†ºÂºè
            const audioExts = ['mp3', 'wav', 'ogg', 'aac', 'm4a'];
            
            const ext = filename.split('.').pop();
            
            if (imageExts.includes(ext)) {
                // ÂõæÁâáÈ¢ÑËßà
                const previewDiv = document.createElement('div');
                previewDiv.className = 'media-preview';
                previewDiv.innerHTML = `
                    <img src="${downloadUrl}" alt="${escapeHtml(fileInfo.filename)}" onclick="window.open('${downloadUrl}', '_blank')" />
                `;
                messageDiv.appendChild(previewDiv);
            } else if (videoExts.includes(ext)) {
                // ËßÜÈ¢ëÈ¢ÑËßà
                const previewDiv = document.createElement('div');
                previewDiv.className = 'media-preview';
                previewDiv.innerHTML = `
                    <video controls>
                        <source src="${downloadUrl}" type="video/${ext === 'mkv' ? 'x-matroska' : ext}">
                        ‰Ω†ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËßÜÈ¢ëÊí≠Êîæ„ÄÇ
                    </video>
                `;
                messageDiv.appendChild(previewDiv);
            } else if (audioExts.includes(ext)) {
                // Èü≥È¢ëÈ¢ÑËßà
                const previewDiv = document.createElement('div');
                previewDiv.className = 'media-preview';
                
                // ‰∏∫‰∏çÂêåÁöÑÈü≥È¢ëÊ†ºÂºèËÆæÁΩÆÊ≠£Á°ÆÁöÑ MIME Á±ªÂûã
                let mimeType = 'audio/' + ext;
                if (ext === 'm4a') {
                    mimeType = 'audio/mp4'; // m4a ‰ΩøÁî® audio/mp4 MIME Á±ªÂûã
                } else if (ext === 'mp3') {
                    mimeType = 'audio/mpeg';
                } else if (ext === 'ogg') {
                    mimeType = 'audio/ogg';
                } else if (ext === 'wav') {
                    mimeType = 'audio/wav';
                } else if (ext === 'aac') {
                    mimeType = 'audio/aac';
                }
                
                previewDiv.innerHTML = `
                    <audio controls preload="metadata">
                        <source src="${downloadUrl}" type="${mimeType}">
                        ‰Ω†ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÈü≥È¢ëÊí≠Êîæ„ÄÇ
                    </audio>
                `;
                messageDiv.appendChild(previewDiv);
            } else {
                // ÊôÆÈÄöÊñá‰ª∂ÔºåÊòæÁ§∫‰∏ãËΩΩÂç°Áâá
                const fileDiv = document.createElement('div');
                fileDiv.className = 'file-message';
                fileDiv.onclick = () => window.location.href = downloadUrl;
                
                // Ê†πÊçÆÊñá‰ª∂Á±ªÂûãÈÄâÊã©ÂõæÊ†á
                let icon = 'üìÑ'; // ÈªòËÆ§ÊñáÊ°£ÂõæÊ†á
                if (['pdf'].includes(ext)) icon = 'üìù';
                else if (['doc', 'docx'].includes(ext)) icon = 'üìÉ';
                else if (['xls', 'xlsx'].includes(ext)) icon = 'üìà';
                else if (['ppt', 'pptx'].includes(ext)) icon = 'üìä';
                else if (['zip', 'rar', '7z'].includes(ext)) icon = 'üóÑÔ∏è';
                else if (['txt'].includes(ext)) icon = 'üìù';
                
                fileDiv.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <span class="file-icon">${icon}</span>
                        <div>
                            <div class="file-name">${escapeHtml(fileInfo.filename)}</div>
                            <div class="file-size">Â§ßÂ∞è: ${fileInfo.size}</div>
                        </div>
                    </div>
                `;
                messageDiv.appendChild(fileDiv);
            }
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function exitRoom() {
            if (socket) {
                socket.emit('leave', {
                    username: currentUsername,
                    room: currentRoom
                });
                socket.disconnect();
            }
            
            // Ê∏ÖÁ©∫Ê∂àÊÅØ
            document.getElementById('messages').innerHTML = '';
            
            // Ê∏ÖÁ©∫ÊàêÂëòÂàóË°®
            document.getElementById('members-list').innerHTML = '';
            document.getElementById('members-count').textContent = '0';
            
            // ÈáçÁΩÆAIÊåâÈíÆ
            aiEnabled = false;
            customAIName = '';
            const aiBtn = document.getElementById('ai-btn');
            const renameBtn = document.getElementById('ai-rename-btn');
            if (aiBtn) {
                aiBtn.classList.remove('active');
                aiBtn.title = 'AIÂä©Êâã';
            }
            if (renameBtn) {
                renameBtn.style.display = 'none';
            }
            
            // ÈáçÁΩÆÂéÜÂè≤ËÆ∞ÂΩïÈù¢Êùø
            historyPanelOpen = false;
            currentHistoryFilter = '';
            const historySidebar = document.getElementById('history-sidebar');
            const historyBtn = document.getElementById('history-toggle-btn');
            if (historySidebar) {
                historySidebar.classList.remove('active');
            }
            if (historyBtn) {
                historyBtn.classList.remove('active');
            }
            const historyMessages = document.getElementById('history-messages');
            if (historyMessages) {
                historyMessages.innerHTML = '<div class="history-loading">üîç ÁÇπÂáªÂàÜÁ±ªÊ†áÁ≠æÂä†ËΩΩÂéÜÂè≤Ê∂àÊÅØ...</div>';
            }
            
            // ÈáçÁΩÆËæìÂÖ•Ê°Ü
            document.getElementById('username').value = '';
            document.getElementById('room').value = '';
            
            // ÂàáÊç¢ÂõûÁôªÂΩïÁïåÈù¢
            document.getElementById('chat-screen').style.display = 'none';
            document.getElementById('login-screen').style.display = 'block';
            document.getElementById('exit-btn').style.display = 'none';
            document.getElementById('room-info').textContent = 'Ê¨¢Ëøé‰ΩøÁî®';
            
            // ÁßªÈô§ËÅäÂ§©Ê®°ÂºèÁ±ªÔºåÊÅ¢Â§çÂéüÂßãÂ∞∫ÂØ∏
            document.querySelector('.container').classList.remove('chat-mode');
            
            // ÈáçÁΩÆÂèòÈáè
            currentUsername = '';
            currentRoom = '';
        }
        
        // Êñá‰ª∂ÈÄâÊã©Â§ÑÁêÜ
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞è (5GB = 5 * 1024 * 1024 * 1024)
            const maxSize = 5 * 1024 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('Êñá‰ª∂Â§ßÂ∞èË∂ÖËøáÈôêÂà∂Ôºà5GBÔºâ');
                event.target.value = '';
                return;
            }
            
            uploadFile(file);
            event.target.value = ''; // Ê∏ÖÁ©∫ËæìÂÖ•ÔºåÂÖÅËÆ∏‰∏ä‰º†Áõ∏ÂêåÊñá‰ª∂
        }
        
        // ‰∏ä‰º†Êñá‰ª∂
        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('room', currentRoom);
            formData.append('username', currentUsername);
            
            // ‰ΩøÁî®ÈöèÊú∫ ID ‰ª•ÊîØÊåÅÂ§ö‰∏™ÂêåÊó∂‰∏ä‰º†
            const progressId = 'progress-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            // ÊòæÁ§∫‰∏ä‰º†ËøõÂ∫¶
            const messagesDiv = document.getElementById('messages');
            const progressDiv = document.createElement('div');
            progressDiv.className = 'upload-progress';
            progressDiv.id = 'container-' + progressId;
            progressDiv.innerHTML = `
                <div>Ê≠£Âú®‰∏ä‰º†: ${escapeHtml(file.name)}</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="${progressId}" style="width: 0%">0%</div>
                </div>
            `;
            messagesDiv.appendChild(progressDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // ‰ΩøÁî® XMLHttpRequest ‰ª•‰æøË∑üË∏™‰∏ä‰º†ËøõÂ∫¶
            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    const progressFill = document.getElementById(progressId);
                    if (progressFill) {
                        progressFill.style.width = percentComplete + '%';
                        progressFill.textContent = percentComplete + '%';
                    }
                }
            });
            
            xhr.addEventListener('load', function() {
                // Âª∂ËøüÁßªÈô§ËøõÂ∫¶Êù°ÔºåÁ≠âÂæÖSocket.IOÊ∂àÊÅØÂà∞Ëææ
                setTimeout(function() {
                    const container = document.getElementById('container-' + progressId);
                    if (container) {
                        container.remove();
                    }
                }, 500);
                
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.success) {
                            console.log('Êñá‰ª∂‰∏ä‰º†ÊàêÂäü:', response.filename);
                        } else if (response.error) {
                            alert('Êñá‰ª∂‰∏ä‰º†Â§±Ë¥•: ' + response.error);
                        }
                    } catch (e) {
                        console.error('Ëß£ÊûêÂìçÂ∫îÂ§±Ë¥•:', e);
                        alert('Êñá‰ª∂‰∏ä‰º†Â§±Ë¥•');
                    }
                } else {
                    alert('Êñá‰ª∂‰∏ä‰º†Â§±Ë¥• (HTTP ' + xhr.status + ')');
                }
            });
            
            xhr.addEventListener('error', function() {
                const container = document.getElementById('container-' + progressId);
                if (container) {
                    container.remove();
                }
                alert('Êñá‰ª∂‰∏ä‰º†ÈîôËØØ');
            });
            
            xhr.open('POST', '/upload');
            xhr.send(formData);
        }
        
        // Á≤òË¥¥ÂõæÁâáÁõ∏ÂÖ≥ÂèòÈáè
        let pastedImageFile = null;
        
        // ÂêØÁî®Á≤òË¥¥‰∏ä‰º†ÂäüËÉΩ
        function enablePasteUpload() {
            document.addEventListener('paste', function(e) {
                // Ê£ÄÊü•ÊòØÂê¶Âú®ËÅäÂ§©ÁïåÈù¢
                if (!currentRoom || document.getElementById('chat-screen').style.display !== 'flex') {
                    return;
                }
                
                const items = e.clipboardData.items;
                
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    
                    // Ê£ÄÊü•ÊòØÂê¶‰∏∫ÂõæÁâá
                    if (item.type.indexOf('image') !== -1) {
                        e.preventDefault();
                        
                        const blob = item.getAsFile();
                        if (blob) {
                            // ÂàõÂª∫‰∏Ä‰∏™ÊúâÊÑè‰πâÁöÑÊñá‰ª∂Âêç
                            const timestamp = new Date().getTime();
                            const fileName = `Á≤òË¥¥ÂõæÁâá_${timestamp}.png`;
                            
                            // ÂàõÂª∫ File ÂØπË±°
                            pastedImageFile = new File([blob], fileName, { type: blob.type });
                            
                            // ÊòæÁ§∫È¢ÑËßà
                            showPastePreview(blob);
                        }
                        break;
                    }
                }
            });
        }
        
        // ÊòæÁ§∫Á≤òË¥¥ÂõæÁâáÈ¢ÑËßà
        function showPastePreview(blob) {
            const previewContainer = document.getElementById('paste-preview');
            const previewImage = document.getElementById('paste-preview-image');
            
            console.log('ÊòæÁ§∫Á≤òË¥¥ÂõæÁâáÈ¢ÑËßà, Êñá‰ª∂Â§ßÂ∞è:', blob.size, 'bytes');
            
            // ÂàõÂª∫ÂõæÁâáURL
            const imageUrl = URL.createObjectURL(blob);
            previewImage.src = imageUrl;
            
            // ÊòæÁ§∫È¢ÑËßàÂÆπÂô®
            previewContainer.classList.add('active');
        }
        
        // ÂèëÈÄÅÁ≤òË¥¥ÁöÑÂõæÁâá
        function sendPasteImage() {
            if (pastedImageFile) {
                console.log('ÂáÜÂ§á‰∏ä‰º†Á≤òË¥¥ÁöÑÂõæÁâá:', pastedImageFile.name);
                
                // ÂÖà‰øùÂ≠òÊñá‰ª∂ÂºïÁî®
                const fileToUpload = pastedImageFile;
                
                // ÈöêËóèÈ¢ÑËßà
                cancelPastePreview();
                
                // ‰∏ä‰º†Êñá‰ª∂
                uploadFile(fileToUpload);
            } else {
                console.error('Ê≤°ÊúâÊâæÂà∞Á≤òË¥¥ÁöÑÂõæÁâáÊñá‰ª∂');
            }
        }
        
        // ÂèñÊ∂àÁ≤òË¥¥È¢ÑËßà
        function cancelPastePreview() {
            const previewContainer = document.getElementById('paste-preview');
            const previewImage = document.getElementById('paste-preview-image');
            
            // ÈöêËóèÈ¢ÑËßàÂÆπÂô®
            previewContainer.classList.remove('active');
            
            // Ê∏ÖÁ©∫ÂõæÁâáÂíåÊñá‰ª∂
            if (previewImage.src) {
                URL.revokeObjectURL(previewImage.src);
            }
            previewImage.src = '';
            pastedImageFile = null;
        }
        
        // È°µÈù¢ÂÖ≥Èó≠Êó∂Á¶ªÂºÄÊàøÈó¥
        window.addEventListener('beforeunload', function() {
            if (socket) {
                socket.emit('leave', {
                    username: currentUsername,
                    room: currentRoom
                });
            }
        });
    </script>
</body>
</html>
