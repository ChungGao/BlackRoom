<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç®¡ç† - {{ site_title }}</title>
    <style>
        :root {
            --bg-gradient-start: #0a0a0f;
            --bg-gradient-end: #0d1117;
            --container-bg: #010409;
            --text-color: #c9d1d9;
            --text-secondary: #8b949e;
            --accent-color: #58a6ff;
            --border-color: #30363d;
            --card-bg: #161b22;
            --card-hover: #1c2128;
            --success-color: #238636;
            --danger-color: #da3633;
            --warning-color: #d29922;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: var(--container-bg);
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            color: var(--accent-color);
        }

        .back-btn {
            padding: 8px 16px;
            background: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            text-decoration: none;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: var(--card-hover);
            border-color: var(--accent-color);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--container-bg);
            padding: 10px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .tab-btn:hover {
            background: var(--card-bg);
            color: var(--text-color);
        }

        .tab-btn.active {
            background: var(--accent-color);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--container-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .stat-card h3 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            color: var(--accent-color);
        }

        .rooms-table {
            background: var(--container-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--card-bg);
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 13px;
        }

        tbody tr {
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: var(--card-hover);
        }

        .online-badge {
            display: inline-block;
            padding: 2px 8px;
            background: var(--success-color);
            color: white;
            border-radius: 12px;
            font-size: 12px;
        }

        .offline-badge {
            display: inline-block;
            padding: 2px 8px;
            background: var(--text-secondary);
            color: white;
            border-radius: 12px;
            font-size: 12px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn-view {
            background: var(--accent-color);
            color: white;
            margin-right: 5px;
        }

        .btn-view:hover {
            opacity: 0.8;
        }

        .btn-delete {
            background: var(--danger-color);
            color: white;
        }

        .btn-delete:hover {
            opacity: 0.8;
        }

        .config-form {
            background: var(--container-bg);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            max-width: 600px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-color);
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .btn-save {
            padding: 10px 24px;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-save:hover {
            opacity: 0.8;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: var(--accent-color);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: var(--danger-color);
        }

        .message-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .message-item {
            padding: 10px;
            margin-bottom: 10px;
            background: var(--card-bg);
            border-radius: 6px;
            border-left: 3px solid var(--accent-color);
        }

        .message-item.system {
            border-left-color: var(--text-secondary);
        }

        .message-username {
            font-weight: bold;
            color: var(--accent-color);
            margin-right: 8px;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-left: 8px;
        }

        .file-list {
            display: grid;
            gap: 10px;
        }

        .file-item {
            padding: 10px;
            background: var(--card-bg);
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .refresh-btn {
            padding: 8px 16px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            opacity: 0.8;
        }

        .file-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 5px;
        }

        .badge-hashed {
            background: var(--accent-color);
            color: white;
        }

        .badge-orphaned {
            background: var(--warning-color);
            color: white;
        }

        .badge-active {
            background: var(--success-color);
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        /* æ–‡ä»¶ç¼©ç•¥å›¾æ ·å¼ */
        .file-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .file-thumbnail:hover {
            transform: scale(1.1);
        }

        .file-icon {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--card-bg);
            border-radius: 6px;
            font-size: 24px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .file-icon:hover {
            background: var(--card-hover);
        }

        /* é¢„è§ˆæ¨¡æ€æ¡† */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .preview-modal.active {
            display: flex;
        }

        .preview-content {
            max-width: 90%;
            max-height: 90vh;
            position: relative;
        }

        .preview-content img,
        .preview-content video,
        .preview-content audio {
            max-width: 100%;
            max-height: 85vh;
            border-radius: 8px;
        }

        .preview-content iframe {
            width: 90vw;
            height: 85vh;
            border: none;
            border-radius: 8px;
            background: white;
        }

        .preview-header {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--container-bg);
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            z-index: 2001;
        }

        .preview-close {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--danger-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            z-index: 2001;
            transition: transform 0.2s;
        }

        .preview-close:hover {
            transform: scale(1.1);
        }

        .preview-download {
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            z-index: 2001;
            transition: opacity 0.2s;
        }

        .preview-download:hover {
            opacity: 0.8;
        }

        .text-preview {
            background: var(--container-bg);
            color: var(--text-color);
            padding: 20px;
            border-radius: 8px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ åå°ç®¡ç†ç³»ç»Ÿ</h1>
            <div>
                <button class="refresh-btn" style="margin-right: 10px;" onclick="window.location.href='/admin/logout'">ğŸšª é€€å‡ºç™»å½•</button>
                <a href="/" class="back-btn">â† è¿”å›èŠå¤©å®¤</a>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('overview')">æ¦‚è§ˆ</button>
            <button class="tab-btn" onclick="switchTab('rooms')">æˆ¿é—´ç®¡ç†</button>
            <button class="tab-btn" onclick="switchTab('files')">æ–‡ä»¶ç®¡ç†</button>
            <button class="tab-btn" onclick="switchTab('config')">ç½‘ç«™é…ç½®</button>
            <button class="tab-btn" onclick="switchTab('ollama')">AIè®¾ç½®</button>
            <button class="tab-btn" onclick="switchTab('account')">è´¦æˆ·ç®¡ç†</button>
        </div>

        <!-- æ¦‚è§ˆæ ‡ç­¾é¡µ -->
        <div id="tab-overview" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>æœåŠ¡å™¨çŠ¶æ€</h3>
                    <div class="value" id="stat-status" style="font-size: 20px;">
                        <span style="color: var(--success-color);">â— è¿è¡Œä¸­</span>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>è¿è¡Œæ—¶é•¿</h3>
                    <div class="value" id="stat-uptime" style="font-size: 18px;">-</div>
                </div>
                <div class="stat-card">
                    <h3>æ€»æˆ¿é—´æ•°</h3>
                    <div class="value" id="stat-rooms">-</div>
                </div>
                <div class="stat-card">
                    <h3>æ€»æ¶ˆæ¯æ•°</h3>
                    <div class="value" id="stat-messages">-</div>
                </div>
                <div class="stat-card">
                    <h3>æ€»æ–‡ä»¶æ•°</h3>
                    <div class="value" id="stat-files">-</div>
                </div>
                <div class="stat-card">
                    <h3>æ–‡ä»¶æ€»å¤§å°</h3>
                    <div class="value" id="stat-size">-</div>
                </div>
                <div class="stat-card">
                    <h3>åœ¨çº¿ç”¨æˆ·</h3>
                    <div class="value" id="stat-online">-</div>
                </div>
                <div class="stat-card">
                    <h3>AIè¯·æ±‚æ¬¡æ•°</h3>
                    <div class="value" id="stat-ai-requests">-</div>
                </div>
                <div class="stat-card">
                    <h3>AIæˆåŠŸç‡</h3>
                    <div class="value" id="stat-ai-success-rate">-</div>
                </div>
                <div class="stat-card">
                    <h3>å¯åŠ¨æ—¶é—´</h3>
                    <div class="value" id="stat-starttime" style="font-size: 16px;">-</div>
                </div>
            </div>
            
            <!-- æœåŠ¡å™¨é…ç½®ä¿¡æ¯ -->
            <div class="rooms-table" style="margin-top: 20px;">
                <div style="padding: 15px; background: var(--card-bg); border-bottom: 1px solid var(--border-color);">
                    <h3 style="color: var(--accent-color); margin: 0;">ğŸ› ï¸ æœåŠ¡å™¨ä¿¡æ¯</h3>
                </div>
                <table>
                    <tbody>
                        <tr>
                            <td style="width: 200px; font-weight: 600; color: var(--text-secondary);">Python ç‰ˆæœ¬</td>
                            <td id="config-python">-</td>
                        </tr>
                        <tr>
                            <td style="width: 200px; font-weight: 600; color: var(--text-secondary);">æ“ä½œç³»ç»Ÿ</td>
                            <td id="config-os">-</td>
                        </tr>
                        <tr>
                            <td style="width: 200px; font-weight: 600; color: var(--text-secondary);">å¤„ç†å™¨</td>
                            <td id="config-processor">-</td>
                        </tr>
                        <tr>
                            <td style="width: 200px; font-weight: 600; color: var(--text-secondary);">RAMå¤§å°</td>
                            <td id="config-memory">-</td>
                        </tr>
                        <tr>
                            <td style="width: 200px; font-weight: 600; color: var(--text-secondary);">ç£ç›˜å¤§å°</td>
                            <td id="config-disk">-</td>
                        </tr>
                        <tr>
                            <td style="width: 200px; font-weight: 600; color: var(--text-secondary);">æ–‡ä»¶ä¸Šä¼ é™åˆ¶</td>
                            <td id="config-maxsize">-</td>
                        </tr>
                        <tr>
                            <td style="width: 200px; font-weight: 600; color: var(--text-secondary);">æ–‡ä»¶ç¼“å­˜ç›®å½•</td>
                            <td id="config-uploadfolder">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- æˆ¿é—´ç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="tab-rooms" class="tab-content">
            <div style="margin-bottom: 15px;">
                <button class="refresh-btn" onclick="loadRooms()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
            </div>
            <div class="rooms-table">
                <table>
                    <thead>
                        <tr>
                            <th>æˆ¿é—´ID</th>
                            <th>æ¶ˆæ¯æ•°</th>
                            <th>æ–‡ä»¶æ•°</th>
                            <th>æ–‡ä»¶å¤§å°</th>
                            <th>åœ¨çº¿ç”¨æˆ·</th>
                            <th>æœ€åæ´»è·ƒ</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="rooms-tbody">
                        <tr>
                            <td colspan="7" class="loading">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- æ–‡ä»¶ç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="tab-files" class="tab-content">
            <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <button class="refresh-btn" onclick="loadFiles()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                <button class="btn-delete" style="padding: 8px 16px; border-radius: 6px; font-size: 14px;" onclick="cleanupOrphanedFiles()">ğŸ§¹ æ¸…ç†å­¤ç«‹æ–‡ä»¶</button>
                
                <!-- æ–‡ä»¶ç±»å‹ç­›é€‰ -->
                <div style="display: flex; gap: 5px; align-items: center;">
                    <label style="color: var(--text-secondary); font-size: 14px;">ç±»å‹ç­›é€‰ï¼š</label>
                    <select id="file-type-filter" onchange="filterFilesByType()" style="padding: 6px 12px; background: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                        <option value="all">å…¨éƒ¨æ–‡ä»¶</option>
                        <option value="image">ğŸ–¼ï¸ å›¾ç‰‡</option>
                        <option value="video">ğŸ¥ è§†é¢‘</option>
                        <option value="audio">ğŸµ éŸ³é¢‘</option>
                        <option value="pdf">ğŸ“ PDF</option>
                        <option value="text">ğŸ“„ æ–‡æœ¬</option>
                        <option value="archive">ğŸ—„ï¸ å‹ç¼©åŒ…</option>
                        <option value="word">ğŸ“ƒ Word</option>
                        <option value="excel">ğŸ“ˆ Excel</option>
                        <option value="powerpoint">ğŸ“Š PPT</option>
                        <option value="other">ğŸ“ å…¶ä»–</option>
                    </select>
                </div>
                
                <!-- æ‰¹é‡æ“ä½œ -->
                <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                    <button id="select-all-btn" class="action-btn btn-view" onclick="toggleSelectAll()" style="display: none;">â˜‘ï¸ å…¨é€‰</button>
                    <button id="batch-delete-btn" class="btn-delete" style="padding: 8px 16px; border-radius: 6px; font-size: 14px; display: none;" onclick="batchDeleteFiles()">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
                    <span id="selected-count" style="color: var(--text-secondary); font-size: 14px; display: none;"></span>
                </div>
            </div>
            <div class="rooms-table">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll()" style="display: none;"></th>
                            <th>ç¼©ç•¥å›¾</th>
                            <th>æ–‡ä»¶å</th>
                            <th>æ–‡ä»¶å¤§å°</th>
                            <th>ä¿®æ”¹æ—¶é—´</th>
                            <th>å¼•ç”¨æˆ¿é—´</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="files-tbody">
                        <tr>
                            <td colspan="8" class="loading">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ç½‘ç«™é…ç½®æ ‡ç­¾é¡µ -->
        <div id="tab-config" class="tab-content">
            <div class="config-form">
                <h2 style="margin-bottom: 20px; color: var(--accent-color);">ç½‘ç«™é…ç½®</h2>
                <div class="form-group">
                    <label>ç½‘ç«™æ ‡é¢˜</label>
                    <input type="text" id="config-title" placeholder="å®æ—¶èŠå¤©å®¤">
                </div>
                <div class="form-group">
                    <label>ç½‘ç«™æè¿°</label>
                    <textarea id="config-description" rows="3" placeholder="ä¸€ä¸ªåŸºäºFlask-SocketIOçš„å®æ—¶èŠå¤©åº”ç”¨"></textarea>
                </div>
                <button class="btn-save" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
            </div>
        </div>

        <!-- è´¦æˆ·ç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="tab-account" class="tab-content">
            <div class="config-form">
                <h2 style="margin-bottom: 20px; color: var(--accent-color);">ç®¡ç†å‘˜è´¦æˆ·ç®¡ç†</h2>
                <div class="form-group">
                    <label>æ–°ç”¨æˆ·åï¼ˆç•™ç©ºåˆ™ä¸ä¿®æ”¹ï¼‰</label>
                    <input type="text" id="new-username" placeholder="admin">
                </div>
                <div class="form-group">
                    <label>åŸå¯†ç </label>
                    <input type="password" id="old-password" placeholder="è¯·è¾“å…¥åŸå¯†ç " required>
                </div>
                <div class="form-group">
                    <label>æ–°å¯†ç ï¼ˆç•™ç©ºåˆ™ä¸ä¿®æ”¹ï¼‰</label>
                    <input type="password" id="new-password" placeholder="è¯·è¾“å…¥æ–°å¯†ç ">
                </div>
                <div class="form-group">
                    <label>ç¡®è®¤æ–°å¯†ç </label>
                    <input type="password" id="confirm-password" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                </div>
                <button class="btn-save" onclick="changePassword()">ğŸ”‘ æ›´æ–°è´¦æˆ·ä¿¡æ¯</button>
            </div>
        </div>

        <!-- Ollama AIè®¾ç½®æ ‡ç­¾é¡µ -->
        <div id="tab-ollama" class="tab-content" style="max-width: none; width: 100%;">
            <div class="config-form" style="max-width: none; width: 100%;">
                <div class="ai-topbar" style="display: flex; gap: 16px; align-items: center; padding: 14px 16px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 18px;">
                    <div class="top-item" style="display: flex; align-items: center; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 10px; margin: 0;">
                            <input type="checkbox" id="global-ai-enabled" style="width: auto;">
                            å¯ç”¨ AI åŠŸèƒ½
                        </label>
                        <small style="color: var(--text-secondary);">å…¨å±€å¼€å…³ï¼Œæ ¹æ®é»˜è®¤æä¾›æ–¹ç”Ÿæ•ˆ</small>
                    </div>
                    <div class="top-item" style="display: flex; align-items: center; gap: 10px;">
                        <label style="margin: 0;">é»˜è®¤AIæä¾›æ–¹</label>
                        <select id="ai-provider" style="padding: 10px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color);">
                            <option value="ollama">Ollama</option>
                            <option value="thirdparty">ç¬¬ä¸‰æ–¹API</option>
                        </select>
                    </div>
                    <div class="top-item" style="margin-left: auto;">
                        <button class="btn-save" onclick="saveAISettings()">ğŸ’¾ ä¿å­˜å½“å‰è®¾ç½®</button>
                    </div>
                </div>

                <div class="ai-settings-grid" style="display: grid; grid-template-columns: repeat(2, minmax(360px, 1fr)); gap: 20px; align-items: start;">
                    <!-- å·¦ä¾§ï¼šOllama è®¾ç½® -->
                    <div class="ai-panel" style="padding: 16px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; line-height: 1.6; word-break: break-word;">
                        <h2 style="margin-bottom: 20px; color: var(--accent-color);">ğŸ¤– Ollama è®¾ç½®</h2>

                        <input type="checkbox" id="ollama-enabled" style="display:none;">

                <div class="form-group">
                    <label>Ollama API åœ°å€</label>
                    <input type="text" id="ollama-api-url" placeholder="http://localhost:11434">
                    <small style="color: var(--text-secondary);">æœ¬åœ°OllamaæœåŠ¡åœ°å€ï¼Œé»˜è®¤ç«¯å£11434</small>
                </div>

                <div class="form-group">
                    <label>æ¨¡å‹åç§°</label>
                    <input type="text" id="ollama-model" placeholder="qwen2.5:latest">
                    <small style="color: var(--text-secondary);">ä½¿ç”¨çš„æ¨¡å‹åç§°ï¼Œä¾‹å¦‚: qwen2.5:latest, llama3:latest</small>
                </div>

                <div class="form-group">
                    <label>Temperature (åˆ›é€ æ€§)</label>
                    <input type="number" id="ollama-temperature" min="0" max="2" step="0.1" placeholder="0.7">
                    <small style="color: var(--text-secondary);">0-2ä¹‹é—´ï¼Œå€¼è¶Šå¤§å›ç­”è¶Šæœ‰åˆ›é€ æ€§ï¼Œå»ºè®®0.7</small>
                </div>

                <div class="form-group">
                    <label>æœ€å¤§å›å¤é•¿åº¦</label>
                    <input type="number" id="ollama-max-tokens" min="100" max="4000" step="100" placeholder="2000">
                    <small style="color: var(--text-secondary);">AIå•æ¬¡å›å¤çš„æœ€å¤§å­—æ•°</small>
                </div>

                <div class="form-group">
                    <label>ç³»ç»Ÿæç¤ºè¯</label>
                    <textarea id="ollama-system-prompt" rows="4" placeholder="ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„AIåŠ©æ‰‹..."></textarea>
                    <small style="color: var(--text-secondary);">å®šä¹‰AIçš„è§’è‰²å’Œè¡Œä¸ºæ–¹å¼</small>
                </div>

                <div class="form-group">
                    <label>AIåŠ©æ‰‹æ˜µç§°</label>
                    <input type="text" id="ollama-ai-name" placeholder="AIåŠ©æ‰‹">
                    <small style="color: var(--text-secondary);">èŠå¤©å®¤ä¸­æ˜¾ç¤ºçš„AIé»˜è®¤æ˜µç§°ï¼Œç”¨æˆ·å¯åœ¨èŠå¤©å®¤å†…ä¸´æ—¶ä¿®æ”¹</small>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="btn-save" style="background: var(--accent-color);" onclick="testOllamaConnection()">ğŸ”Œ æµ‹è¯•Ollamaè¿æ¥</button>
                </div>
                
                        <div id="ollama-test-result" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
                    </div>

                    <!-- å³ä¾§ï¼šç¬¬ä¸‰æ–¹è®¾ç½® -->
                    <div class="ai-panel" style="padding: 16px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; line-height: 1.6; word-break: break-word;">
                        <h2 style="margin-bottom: 20px; color: var(--accent-color);">ğŸŒ API è®¾ç½®</h2>

                        <!-- å¯ç”¨ç¬¬ä¸‰æ–¹AIå¤é€‰æ¡†å·²ç§»é™¤ï¼Œç»Ÿä¸€ç”±é¡¶éƒ¨æ§åˆ¶ -->

                        <div class="form-group">
                            <label>API Base URL</label>
                            <input type="text" id="thirdparty-api-base-url" placeholder="https://api.openai.com">
                            <small style="color: var(--text-secondary);">ç¬¬ä¸‰æ–¹APIåŸºç¡€åœ°å€ï¼Œä¾‹å¦‚OpenAIä¸º https://api.openai.com</small>
                        </div>

                        <div class="form-group">
                            <label>API Key</label>
                            <input type="password" id="thirdparty-api-key" placeholder="å¡«å†™ç¬¬ä¸‰æ–¹API Key">
                            <small style="color: var(--text-secondary);">ç”¨äºè®¿é—®ç¬¬ä¸‰æ–¹APIçš„å¯†é’¥</small>
                        </div>

                        <div class="form-group">
                            <label>æ¨¡å‹åç§°</label>
                            <input type="text" id="thirdparty-model" placeholder="ä¾‹å¦‚ gpt-4o-mini">
                            <small style="color: var(--text-secondary);">å…¼å®¹OpenAIçš„æ¨¡å‹åç§°</small>
                        </div>

                        <div class="form-group">
                            <label>Temperature (åˆ›é€ æ€§)</label>
                            <input type="number" id="thirdparty-temperature" min="0" max="2" step="0.1" placeholder="0.7">
                        </div>

                        <div class="form-group">
                            <label>æœ€å¤§å›å¤é•¿åº¦</label>
                            <input type="number" id="thirdparty-max-tokens" min="100" max="32000" step="100" placeholder="2000">
                        </div>

                        <div class="form-group">
                            <label>ç³»ç»Ÿæç¤ºè¯</label>
                            <textarea id="thirdparty-system-prompt" rows="4" placeholder="ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„AIåŠ©æ‰‹..."></textarea>
                        </div>

                        <div class="form-group">
                            <label>AIåŠ©æ‰‹æ˜µç§°</label>
                            <input type="text" id="thirdparty-ai-name" placeholder="AIåŠ©æ‰‹">
                        </div>

                        <div style="display: flex; gap: 10px;">
                            <button class="btn-save" style="background: var(--accent-color);" onclick="testThirdpartyConnection()">ğŸ”Œ æµ‹è¯•APIè¿æ¥</button>
                        </div>

                        <div id="thirdparty-test-result" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æˆ¿é—´è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="room-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æˆ¿é—´è¯¦æƒ…: <span id="modal-room-id"></span></h2>
                <button class="close-btn" onclick="closeModal()">Ã—</button>
            </div>
            
            <h3 style="margin-bottom: 10px; color: var(--text-color);">èŠå¤©è®°å½•</h3>
            <div class="message-list" id="modal-messages">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>

            <h3 style="margin-bottom: 10px; color: var(--text-color);">æ–‡ä»¶åˆ—è¡¨</h3>
            <div class="file-list" id="modal-files">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- æ–‡ä»¶é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="preview-modal" class="preview-modal">
        <div class="preview-header">
            <span id="preview-filename" style="color: var(--text-color); font-weight: bold;"></span>
        </div>
        <button class="preview-close" onclick="closePreview()">Ã—</button>
        <button class="preview-download" onclick="downloadCurrentFile()">â¬‡ï¸ ä¸‹è½½</button>
        <div class="preview-content" id="preview-content"></div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // Socket.IO è¿æ¥
        const socket = io();
        let currentTab = 'overview';
        let statsUpdateInterval = null;

        // ç›‘å¬ Socket.IO è¿æ¥çŠ¶æ€
        socket.on('connect', function() {
            console.log('Socket.IO å·²è¿æ¥');
            updateServerStatus(true);
        });

        socket.on('disconnect', function() {
            console.log('Socket.IO å·²æ–­å¼€');
            updateServerStatus(false);
        });

        socket.on('connect_error', function() {
            console.log('Socket.IO è¿æ¥é”™è¯¯');
            updateServerStatus(false);
        });

        // æ›´æ–°æœåŠ¡å™¨çŠ¶æ€æ˜¾ç¤º
        function updateServerStatus(isOnline) {
            const statusElem = document.getElementById('stat-status');
            if (statusElem) {
                if (isOnline) {
                    statusElem.innerHTML = '<span style="color: var(--success-color);">â— è¿è¡Œä¸­</span>';
                } else {
                    statusElem.innerHTML = '<span style="color: var(--danger-color);">â— ç¦»çº¿</span>';
                    // æœåŠ¡å™¨ç¦»çº¿æ—¶æ¸…ç©ºè¿è¡Œæ—¶é•¿å’Œå¯åŠ¨æ—¶é—´
                    const uptimeElem = document.getElementById('stat-uptime');
                    const starttimeElem = document.getElementById('stat-starttime');
                    if (uptimeElem) uptimeElem.textContent = '-';
                    if (starttimeElem) starttimeElem.textContent = '-';
                }
            }
        }

        // ç›‘å¬æœåŠ¡å™¨æ•°æ®æ›´æ–°äº‹ä»¶
        socket.on('admin_data_update', function(data) {
            console.log('æ”¶åˆ°æ•°æ®æ›´æ–°é€šçŸ¥:', data.type);
            
            // æ ¹æ®æ›´æ–°ç±»å‹åˆ·æ–°å¯¹åº”æ•°æ®
            if (data.type === 'stats' && currentTab === 'overview') {
                loadStats();
            } else if (data.type === 'rooms' && currentTab === 'rooms') {
                loadRooms();
            } else if (data.type === 'files' && currentTab === 'files') {
                loadFiles();
            } else if (data.type === 'config' && currentTab === 'config') {
                loadConfig();
            }
            
            // stats æ›´æ–°æ—¶ï¼Œå¦‚æœå½“å‰åœ¨æ¦‚è§ˆé¡µé¢åˆ™åˆ·æ–°
            if (data.type === 'stats' && currentTab === 'overview') {
                loadStats();
            }
            // rooms æ›´æ–°æ—¶ï¼Œå¦‚æœåœ¨æˆ¿é—´ç®¡ç†é¡µé¢åˆ™åˆ·æ–°
            if (data.type === 'rooms' && currentTab === 'rooms') {
                loadRooms();
            }
        });

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            currentTab = tabName;
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µ
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');

            // åŠ è½½å¯¹åº”æ•°æ®
            if (tabName === 'overview') {
                loadStats();
                // å¼€å¯å®šæ—¶æ›´æ–°è¿è¡Œæ—¶é•¿
                startStatsUpdate();
            } else {
                // åœæ­¢å®šæ—¶æ›´æ–°
                stopStatsUpdate();
                if (tabName === 'rooms') {
                    loadRooms();
                } else if (tabName === 'files') {
                    loadFiles();
                } else if (tabName === 'config') {
                    loadConfig();
                } else if (tabName === 'ollama') {
                    loadAIProvider();
                    loadOllamaConfig();
                    loadThirdpartyConfig();
                }
            }
        }
        
        // å¼€å¯å®šæ—¶æ›´æ–°ç»Ÿè®¡æ•°æ®ï¼ˆæ¯5ç§’æ›´æ–°è¿è¡Œæ—¶é•¿ï¼‰
        function startStatsUpdate() {
            stopStatsUpdate(); // å…ˆæ¸…é™¤æ—§çš„å®šæ—¶å™¨
            statsUpdateInterval = setInterval(function() {
                if (currentTab === 'overview' && socket.connected) {
                    loadStats();
                }
            }, 5000); // æ¯5ç§’æ›´æ–°ä¸€æ¬¡
        }
        
        // åœæ­¢å®šæ—¶æ›´æ–°
        function stopStatsUpdate() {
            if (statsUpdateInterval) {
                clearInterval(statsUpdateInterval);
                statsUpdateInterval = null;
            }
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const response = await fetch('/api/admin/stats', { credentials: 'same-origin' });
                // å¦‚æœæœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
                if (response.status === 401) {
                    window.location.href = '/admin/login';
                    return;
                }
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('stat-rooms').textContent = data.stats.total_rooms;
                    document.getElementById('stat-messages').textContent = data.stats.total_messages;
                    document.getElementById('stat-files').textContent = data.stats.total_files;
                    document.getElementById('stat-size').textContent = data.stats.total_file_size;
                    document.getElementById('stat-online').textContent = data.stats.online_users;
                    // AIç»Ÿè®¡
                    if (document.getElementById('stat-ai-requests')) {
                        document.getElementById('stat-ai-requests').textContent = data.stats.ai_requests_total ?? 0;
                    }
                    if (document.getElementById('stat-ai-success-rate')) {
                        document.getElementById('stat-ai-success-rate').textContent = data.stats.ai_success_rate ?? '0.0%';
                    }
                    
                    // æ˜¾ç¤ºè¿è¡Œæ—¶é•¿
                    document.getElementById('stat-uptime').textContent = data.stats.uptime || '-';
                    
                    // æ˜¾ç¤ºå¯åŠ¨æ—¶é—´
                    document.getElementById('stat-starttime').textContent = data.stats.start_time || '-';
                    
                    // æ˜¾ç¤ºæœåŠ¡å™¨é…ç½®ä¿¡æ¯
                    if (data.stats.server_config) {
                        document.getElementById('config-python').textContent = data.stats.server_config.python_version;
                        document.getElementById('config-os').textContent = data.stats.server_config.os;
                        document.getElementById('config-processor').textContent = data.stats.server_config.processor || '-';
                        document.getElementById('config-memory').textContent = data.stats.server_config.total_memory || '-';
                        document.getElementById('config-disk').textContent = data.stats.server_config.total_disk || '-';
                        document.getElementById('config-maxsize').textContent = data.stats.server_config.max_file_size;
                        document.getElementById('config-uploadfolder').textContent = data.stats.server_config.upload_folder;
                    }
                    
                    // æœåŠ¡å™¨åœ¨çº¿ï¼Œæ›´æ–°çŠ¶æ€
                    updateServerStatus(true);
                } else {
                    // å¦‚æœè¿”å›æˆåŠŸæ ‡è®°ä¸º falseï¼Œåˆ™å°†æœåŠ¡å™¨çŠ¶æ€æ˜¾ç¤ºä¸ºç¦»çº¿
                    updateServerStatus(false);
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                // å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œæ˜¾ç¤ºæœåŠ¡å™¨ç¦»çº¿
                updateServerStatus(false);
                // åœ¨æ¦‚è§ˆé¡µæ˜¾ç¤ºä¸€æ¡ç®€çŸ­é”™è¯¯æç¤ºï¼ˆä¸æ‰“æ‰°æ•´ä½“UIï¼‰
                const uptimeElem = document.getElementById('stat-uptime');
                if (uptimeElem) {
                    uptimeElem.textContent = '-';
                }
            }
        }

        // åŠ è½½æˆ¿é—´åˆ—è¡¨
        async function loadRooms() {
            try {
                const tbody = document.getElementById('rooms-tbody');
                tbody.innerHTML = '<tr><td colspan="7" class="loading">åŠ è½½ä¸­...</td></tr>';

                const response = await fetch('/api/admin/rooms');
                const data = await response.json();

                if (data.success) {
                    if (data.rooms.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">æš‚æ— æˆ¿é—´</td></tr>';
                        return;
                    }

                    tbody.innerHTML = data.rooms.map(room => `
                        <tr>
                            <td><strong>${room.room_id}</strong></td>
                            <td>${room.message_count}</td>
                            <td>${room.file_count}</td>
                            <td>${room.file_size}</td>
                            <td>
                                ${room.online_users > 0 
                                    ? `<span class="online-badge">${room.online_users} åœ¨çº¿</span>` 
                                    : '<span class="offline-badge">ç¦»çº¿</span>'}
                            </td>
                            <td>${room.last_active}</td>
                            <td>
                                <button class="action-btn btn-view" onclick="viewRoom('${room.room_id}')">æŸ¥çœ‹</button>
                                <button class="action-btn btn-delete" onclick="deleteRoom('${room.room_id}')">åˆ é™¤</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('åŠ è½½æˆ¿é—´åˆ—è¡¨å¤±è´¥:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--danger-color);">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        // æŸ¥çœ‹æˆ¿é—´è¯¦æƒ…
        async function viewRoom(roomId) {
            try {
                document.getElementById('modal-room-id').textContent = roomId;
                document.getElementById('room-modal').classList.add('active');
                
                const response = await fetch(`/api/admin/room/${roomId}`);
                const data = await response.json();

                if (data.success) {
                    const room = data.room;

                    // æ˜¾ç¤ºæ¶ˆæ¯åˆ—è¡¨
                    const messagesDiv = document.getElementById('modal-messages');
                    if (room.messages.length === 0) {
                        messagesDiv.innerHTML = '<div style="color: var(--text-secondary); text-align: center;">æš‚æ— æ¶ˆæ¯</div>';
                    } else {
                        messagesDiv.innerHTML = room.messages.map(msg => `
                            <div class="message-item ${msg.type}">
                                <span class="message-username">${msg.username}:</span>
                                <span>${msg.message}</span>
                                <span class="message-time">${msg.timestamp}</span>
                            </div>
                        `).join('');
                    }

                    // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
                    const filesDiv = document.getElementById('modal-files');
                    if (room.files.length === 0) {
                        filesDiv.innerHTML = '<div style="color: var(--text-secondary); text-align: center;">æš‚æ— æ–‡ä»¶</div>';
                    } else {
                        filesDiv.innerHTML = room.files.map(file => `
                            <div class="file-item">
                                <span>ğŸ“ ${file}</span>
                                <a href="/download/${file}" style="color: var(--accent-color); text-decoration: none;">ä¸‹è½½</a>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æˆ¿é—´è¯¦æƒ…å¤±è´¥:', error);
                alert('åŠ è½½æˆ¿é—´è¯¦æƒ…å¤±è´¥');
            }
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('room-modal').classList.remove('active');
        }

        // å…¨å±€å˜é‡å­˜å‚¨æ‰€æœ‰æ–‡ä»¶æ•°æ®
        let allFilesData = [];
        let selectedFiles = new Set();
        
        // åŠ è½½æ–‡ä»¶åˆ—è¡¨
        async function loadFiles() {
            try {
                const tbody = document.getElementById('files-tbody');
                tbody.innerHTML = '<tr><td colspan="8" class="loading">åŠ è½½ä¸­...</td></tr>';

                const response = await fetch('/api/admin/files');
                const data = await response.json();

                if (data.success) {
                    allFilesData = data.files;
                    selectedFiles.clear();
                    
                    // æ˜¾ç¤ºå¤é€‰æ¡†å’Œæ‰¹é‡æ“ä½œæŒ‰é’®
                    document.getElementById('select-all-checkbox').style.display = allFilesData.length > 0 ? 'inline-block' : 'none';
                    document.getElementById('select-all-btn').style.display = allFilesData.length > 0 ? 'inline-block' : 'none';
                    
                    // åº”ç”¨å½“å‰ç­›é€‰
                    filterFilesByType();
                }
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--danger-color);">åŠ è½½å¤±è´¥</td></tr>';
            }
        }
        
        // æŒ‰ç±»å‹ç­›é€‰æ–‡ä»¶
        function filterFilesByType() {
            const filterType = document.getElementById('file-type-filter').value;
            const tbody = document.getElementById('files-tbody');
            
            let filteredFiles = allFilesData;
            if (filterType !== 'all') {
                filteredFiles = allFilesData.filter(file => file.file_type === filterType);
            }
            
            if (filteredFiles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-secondary);">æš‚æ— ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶</td></tr>';
                updateBatchButtons();
                return;
            }
            
            tbody.innerHTML = filteredFiles.map(file => {
                const statusBadges = [];
                if (file.is_hashed) {
                    statusBadges.push('<span class="file-badge badge-hashed">å·²ç¼“å­˜</span>');
                }
                if (file.is_orphaned) {
                    statusBadges.push('<span class="file-badge badge-orphaned">å­¤ç«‹</span>');
                } else {
                    statusBadges.push('<span class="file-badge badge-active">æ´»è·ƒ</span>');
                }

                const roomsText = file.referenced_rooms.length > 0 
                    ? file.referenced_rooms.join(', ') 
                    : '<span style="color: var(--text-secondary);">æ— </span>';

                // ç”Ÿæˆç¼©ç•¥å›¾
                let thumbnailHtml = '';
                if (file.file_type === 'image') {
                    thumbnailHtml = `<img src="/download/${file.filename}" class="file-thumbnail" onclick="previewFile('${file.filename}', '${file.file_type}')" alt="${file.filename}">`;
                } else {
                    const icons = {
                        'video': 'ğŸ¥',
                        'audio': 'ğŸµ',
                        'pdf': 'ğŸ“„',
                        'text': 'ğŸ“',
                        'archive': 'ğŸ—„ï¸',
                        'word': 'ğŸ“ƒ',
                        'excel': 'ğŸ“ˆ',
                        'powerpoint': 'ğŸ“Š',
                        'other': 'ğŸ“'
                    };
                    const icon = icons[file.file_type] || 'ğŸ“';
                    thumbnailHtml = `<div class="file-icon" onclick="previewFile('${file.filename}', '${file.file_type}')">${icon}</div>`;
                }
                
                const isChecked = selectedFiles.has(file.filename) ? 'checked' : '';

                return `
                    <tr data-filename="${file.filename}" data-filetype="${file.file_type}">
                        <td><input type="checkbox" class="file-checkbox" value="${file.filename}" onchange="updateFileSelection(this)" ${isChecked}></td>
                        <td>${thumbnailHtml}</td>
                        <td><strong>${file.filename}</strong></td>
                        <td>${file.size}</td>
                        <td>${file.modified_time}</td>
                        <td>${roomsText}</td>
                        <td>${statusBadges.join('')}</td>
                        <td>
                            <button class="action-btn btn-view" onclick="previewFile('${file.filename}', '${file.file_type}')">é¢„è§ˆ</button>
                            <button class="action-btn btn-view" onclick="window.open('/download/${file.filename}', '_blank')">ä¸‹è½½</button>
                            <button class="action-btn btn-delete" onclick="deleteFile('${file.filename}')">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateBatchButtons();
        }
        
        // æ›´æ–°æ–‡ä»¶é€‰æ‹©çŠ¶æ€
        function updateFileSelection(checkbox) {
            if (checkbox.checked) {
                selectedFiles.add(checkbox.value);
            } else {
                selectedFiles.delete(checkbox.value);
            }
            updateBatchButtons();
        }
        
        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const checkboxes = document.querySelectorAll('.file-checkbox');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAllCheckbox.checked;
                if (cb.checked) {
                    selectedFiles.add(cb.value);
                } else {
                    selectedFiles.delete(cb.value);
                }
            });
            
            updateBatchButtons();
        }
        
        // æ›´æ–°æ‰¹é‡æ“ä½œæŒ‰é’®çŠ¶æ€
        function updateBatchButtons() {
            const count = selectedFiles.size;
            const batchDeleteBtn = document.getElementById('batch-delete-btn');
            const selectedCountSpan = document.getElementById('selected-count');
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            
            if (count > 0) {
                batchDeleteBtn.style.display = 'inline-block';
                selectedCountSpan.style.display = 'inline';
                selectedCountSpan.textContent = `å·²é€‰æ‹© ${count} ä¸ªæ–‡ä»¶`;
            } else {
                batchDeleteBtn.style.display = 'none';
                selectedCountSpan.style.display = 'none';
            }
            
            // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
            const allCheckboxes = document.querySelectorAll('.file-checkbox');
            const checkedCount = document.querySelectorAll('.file-checkbox:checked').length;
            selectAllCheckbox.checked = allCheckboxes.length > 0 && checkedCount === allCheckboxes.length;
        }
        
        // æ‰¹é‡åˆ é™¤æ–‡ä»¶
        async function batchDeleteFiles() {
            if (selectedFiles.size === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedFiles.size} ä¸ªæ–‡ä»¶å—ï¼Ÿè¯¥æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                return;
            }
            
            let successCount = 0;
            let failCount = 0;
            
            for (const filename of selectedFiles) {
                try {
                    const response = await fetch(`/api/admin/file/${encodeURIComponent(filename)}`, {
                        method: 'DELETE'
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    console.error(`åˆ é™¤æ–‡ä»¶ ${filename} å¤±è´¥:`, error);
                    failCount++;
                }
            }
            
            alert(`æ‰¹é‡åˆ é™¤å®Œæˆï¼\næˆåŠŸ: ${successCount} ä¸ª\nå¤±è´¥: ${failCount} ä¸ª`);
            
            selectedFiles.clear();
            loadFiles();
            loadStats();
        }

        // åˆ é™¤æ–‡ä»¶
        async function deleteFile(filename) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ ${filename} å—ï¼Ÿè¯¥æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/file/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    alert('åˆ é™¤æˆåŠŸ');
                    loadFiles();
                    loadStats();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åˆ é™¤æ–‡ä»¶å¤±è´¥:', error);
                alert('åˆ é™¤æ–‡ä»¶å¤±è´¥');
            }
        }

        // æ¸…ç†å­¤ç«‹æ–‡ä»¶
        async function cleanupOrphanedFiles() {
            if (!confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰å­¤ç«‹æ–‡ä»¶å—ï¼Ÿå­¤ç«‹æ–‡ä»¶æ˜¯æŒ‡ä¸è¢«ä»»ä½•æˆ¿é—´å¼•ç”¨çš„æ–‡ä»¶ã€‚')) {
                return;
            }

            try {
                const response = await fetch('/api/admin/cleanup-orphaned', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    loadFiles();
                    loadStats();
                } else {
                    alert('æ¸…ç†å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('æ¸…ç†å¤±è´¥:', error);
                alert('æ¸…ç†å¤±è´¥');
            }
        }

        // åˆ é™¤æˆ¿é—´
        async function deleteRoom(roomId) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æˆ¿é—´ ${roomId} å—ï¼Ÿè¿™å°†åŒæ—¶åˆ é™¤è¯¥æˆ¿é—´çš„æ‰€æœ‰æ¶ˆæ¯å’Œå…³è”æ–‡ä»¶ã€‚`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/room/${roomId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    alert('åˆ é™¤æˆåŠŸ');
                    loadRooms();
                    loadStats();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åˆ é™¤æˆ¿é—´å¤±è´¥:', error);
                alert('åˆ é™¤æˆ¿é—´å¤±è´¥');
            }
        }

        // åŠ è½½ç½‘ç«™é…ç½®
        async function loadConfig() {
            try {
                const response = await fetch('/api/admin/config');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('config-title').value = data.config.title || '';
                    document.getElementById('config-description').value = data.config.description || '';
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }

        // ä¿å­˜ç½‘ç«™é…ç½®
        async function saveConfig() {
            try {
                const title = document.getElementById('config-title').value;
                const description = document.getElementById('config-description').value;

                const response = await fetch('/api/admin/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        description: description
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('é…ç½®ä¿å­˜æˆåŠŸï¼');
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                alert('ä¿å­˜é…ç½®å¤±è´¥');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            loadStats();
            // å¼€å¯å®šæ—¶æ›´æ–°
            startStatsUpdate();
        });

        // ä¿®æ”¹ç®¡ç†å‘˜å¯†ç 
        async function changePassword() {
            try {
                const oldPassword = document.getElementById('old-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                const newUsername = document.getElementById('new-username').value;

                if (!oldPassword) {
                    alert('è¯·è¾“å…¥åŸå¯†ç ');
                    return;
                }

                if (newPassword && newPassword !== confirmPassword) {
                    alert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');
                    return;
                }

                if (!newPassword && !newUsername) {
                    alert('è¯·è‡³å°‘ä¿®æ”¹ç”¨æˆ·åæˆ–å¯†ç ');
                    return;
                }

                const response = await fetch('/api/admin/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        old_password: oldPassword,
                        new_password: newPassword || null,
                        new_username: newUsername || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('è´¦æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸï¼è¯·é‡æ–°ç™»å½•ã€‚');
                    window.location.href = '/admin/logout';
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('æ›´æ–°è´¦æˆ·ä¿¡æ¯å¤±è´¥:', error);
                alert('æ›´æ–°è´¦æˆ·ä¿¡æ¯å¤±è´¥');
            }
        }

        // åŠ è½½Ollamaé…ç½®
        async function loadOllamaConfig() {
            try {
                const response = await fetch('/api/admin/ollama-config');
                const data = await response.json();

        if (data.success) {
            document.getElementById('ollama-enabled').checked = data.config.enabled || false;
            document.getElementById('ollama-api-url').value = data.config.api_url || 'http://localhost:11434';
            document.getElementById('ollama-model').value = data.config.model || 'qwen2.5:latest';
            document.getElementById('ollama-temperature').value = data.config.temperature || 0.7;
            document.getElementById('ollama-max-tokens').value = data.config.max_tokens || 2000;
            document.getElementById('ollama-system-prompt').value = data.config.system_prompt || '';
            document.getElementById('ollama-ai-name').value = data.config.ai_name || 'AIåŠ©æ‰‹';
            // è‹¥é»˜è®¤æä¾›æ–¹ä¸ºOllamaï¼Œåˆ™åŒæ­¥åˆ°å…¨å±€å¼€å…³
            if ((document.getElementById('ai-provider')?.value || 'ollama') === 'ollama') {
                const globalToggle = document.getElementById('global-ai-enabled');
                if (globalToggle) globalToggle.checked = !!(data.config.enabled || false);
            }
        }
            } catch (error) {
                console.error('åŠ è½½Ollamaé…ç½®å¤±è´¥:', error);
            }
        }

        // ä¿å­˜Ollamaé…ç½®
        async function saveOllamaConfig() {
            try {
                const config = {
                    enabled: ((document.getElementById('ai-provider')?.value || 'ollama') === 'ollama' ? document.getElementById('global-ai-enabled').checked : false),
                    api_url: document.getElementById('ollama-api-url').value,
                    model: document.getElementById('ollama-model').value,
                    temperature: parseFloat(document.getElementById('ollama-temperature').value),
                    max_tokens: parseInt(document.getElementById('ollama-max-tokens').value),
                    system_prompt: document.getElementById('ollama-system-prompt').value,
                    ai_name: document.getElementById('ollama-ai-name').value.trim() || 'AIåŠ©æ‰‹'
                };

                // æ˜¾ç¤ºåŠ è½½æç¤º
                const resultDiv = document.getElementById('ollama-test-result');
                resultDiv.style.display = 'block';
                resultDiv.style.background = 'var(--card-bg)';
                resultDiv.style.border = '1px solid var(--border-color)';
                resultDiv.style.color = 'var(--text-secondary)';
                resultDiv.innerHTML = 'ğŸ’¾ æ­£åœ¨ä¿å­˜...';

                // ä½¿ç”¨ Promise.race å®ç°è¶…æ—¶æ§åˆ¶
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('ä¿å­˜è¶…æ—¶')), 5000)
                );

                const fetchPromise = fetch('/api/admin/ollama-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const response = await Promise.race([fetchPromise, timeoutPromise]);
                const data = await response.json();

                if (data.success) {
                    resultDiv.style.background = 'var(--success-color)';
                    resultDiv.style.border = '1px solid var(--success-color)';
                    resultDiv.style.color = 'white';
                    resultDiv.innerHTML = 'âœ… Ollamaé…ç½®ä¿å­˜æˆåŠŸï¼';
                    
                    // 3ç§’åéšè—æç¤º
                    setTimeout(() => {
                        resultDiv.style.display = 'none';
                    }, 3000);
                } else {
                    resultDiv.style.background = 'var(--danger-color)';
                    resultDiv.style.border = '1px solid var(--danger-color)';
                    resultDiv.style.color = 'white';
                    resultDiv.innerHTML = 'âŒ ä¿å­˜å¤±è´¥: ' + data.error;
                }
            } catch (error) {
                const resultDiv = document.getElementById('ollama-test-result');
                resultDiv.style.display = 'block';
                resultDiv.style.background = 'var(--danger-color)';
                resultDiv.style.border = '1px solid var(--danger-color)';
                resultDiv.style.color = 'white';
                resultDiv.innerHTML = 'âŒ ä¿å­˜å¤±è´¥: ' + error.message;
            }
        }

        // æµ‹è¯•Ollamaè¿æ¥
        async function testOllamaConnection() {
            const resultDiv = document.getElementById('ollama-test-result');
            resultDiv.style.display = 'block';
            resultDiv.style.background = 'var(--card-bg)';
            resultDiv.style.border = '1px solid var(--border-color)';
            resultDiv.innerHTML = '<span style="color: var(--text-secondary);">ğŸ” æ­£åœ¨è¿æ¥...</span>';

            try {
                // ä½¿ç”¨å½“å‰è¾“å…¥æ¡†ä¸­çš„é…ç½®è¿›è¡Œæµ‹è¯•
                const apiUrl = document.getElementById('ollama-api-url').value;
                
                if (!apiUrl) {
                    resultDiv.style.background = 'var(--danger-color)';
                    resultDiv.style.border = '1px solid var(--danger-color)';
                    resultDiv.style.color = 'white';
                    resultDiv.innerHTML = 'âŒ è¯·å…ˆè¾“å…¥Ollama APIåœ°å€';
                    return;
                }

                const response = await fetch('/api/admin/ollama-test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        api_url: apiUrl
                    })
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.style.background = 'var(--success-color)';
                    resultDiv.style.border = '1px solid var(--success-color)';
                    resultDiv.style.color = 'white';
                    let modelsHtml = '';
                    if (data.models && data.models.length > 0) {
                        modelsHtml = '<br><small>å¯ç”¨æ¨¡å‹: ' + data.models.join(', ') + '</small>';
                    }
                    resultDiv.innerHTML = 'âœ… ' + data.message + modelsHtml;
                } else {
                    resultDiv.style.background = 'var(--danger-color)';
                    resultDiv.style.border = '1px solid var(--danger-color)';
                    resultDiv.style.color = 'white';
                    resultDiv.innerHTML = 'âŒ ' + data.error;
                }
            } catch (error) {
                resultDiv.style.background = 'var(--danger-color)';
                resultDiv.style.border = '1px solid var(--danger-color)';
                resultDiv.style.color = 'white';
                resultDiv.innerHTML = 'âŒ è¿æ¥å¤±è´¥: ' + error.message;
            }
        }

        // åŠ è½½é»˜è®¤AIæä¾›æ–¹
        async function loadAIProvider() {
            try {
                const response = await fetch('/api/admin/ai-provider');
                const data = await response.json();
                if (data.success) {
                    const select = document.getElementById('ai-provider');
                    if (select) select.value = data.provider || 'ollama';
                }
            } catch (error) {
                console.error('åŠ è½½AIæä¾›æ–¹å¤±è´¥:', error);
            }
        }

        // ä¿å­˜é»˜è®¤AIæä¾›æ–¹
        async function saveAIProvider() {
            try {
                const provider = document.getElementById('ai-provider').value;
                const response = await fetch('/api/admin/ai-provider', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider })
                });
                const data = await response.json();
                if (!data.success) alert('æ›´æ–°é»˜è®¤æä¾›æ–¹å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            } catch (error) {
                alert('æ›´æ–°é»˜è®¤æä¾›æ–¹å¤±è´¥: ' + error.message);
            }
        }

        // ç»Ÿä¸€ä¿å­˜AIè®¾ç½®ï¼ˆé»˜è®¤æä¾›æ–¹ + å¯¹åº”é…ç½®ï¼‰
        async function saveAISettings() {
            const provider = document.getElementById('ai-provider')?.value || 'ollama';
            await saveAIProvider();
            if (provider === 'ollama') {
                await saveOllamaConfig();
            } else {
                await saveThirdpartyConfig();
            }
        }

        // ç»‘å®šæä¾›æ–¹é€‰æ‹©ä¸å…¨å±€å¼€å…³å˜æ›´
        document.addEventListener('DOMContentLoaded', function() {
            const select = document.getElementById('ai-provider');
            if (select) {
                select.addEventListener('change', async () => {
                    await saveAIProvider();
                    updateGlobalAIEnabledFromProvider();
                });
            }
            const globalToggle = document.getElementById('global-ai-enabled');
            if (globalToggle) {
                globalToggle.addEventListener('change', () => {
                    setProviderEnabled(globalToggle.checked);
                });
            }
        });

        // åŠ è½½ç¬¬ä¸‰æ–¹AIé…ç½®
        async function loadThirdpartyConfig() {
            try {
                const response = await fetch('/api/admin/thirdparty-config');
                const data = await response.json();
                if (data.success) {
                    const cfg = data.config || {};
                    document.getElementById('thirdparty-api-base-url').value = cfg.api_base_url || '';
                    document.getElementById('thirdparty-api-key').value = cfg.api_key || '';
                    document.getElementById('thirdparty-model').value = cfg.model || '';
                    document.getElementById('thirdparty-temperature').value = (cfg.temperature ?? 0.7);
                    document.getElementById('thirdparty-max-tokens').value = (cfg.max_tokens ?? 2000);
                    document.getElementById('thirdparty-system-prompt').value = cfg.system_prompt || '';
                    document.getElementById('thirdparty-ai-name').value = cfg.ai_name || 'AIåŠ©æ‰‹';
                    // è‹¥é»˜è®¤æä¾›æ–¹ä¸ºç¬¬ä¸‰æ–¹ï¼Œåˆ™åŒæ­¥åˆ°å…¨å±€å¼€å…³
                    if ((document.getElementById('ai-provider')?.value || 'ollama') === 'thirdparty') {
                        const globalToggle = document.getElementById('global-ai-enabled');
                        if (globalToggle) globalToggle.checked = !!cfg.enabled;
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ç¬¬ä¸‰æ–¹AIé…ç½®å¤±è´¥:', error);
            }
        }

        // ä¿å­˜ç¬¬ä¸‰æ–¹AIé…ç½®
        async function saveThirdpartyConfig() {
            const resultDiv = document.getElementById('thirdparty-test-result');
            resultDiv.style.display = 'block';
            resultDiv.style.background = 'var(--card-bg)';
            resultDiv.style.border = '1px solid var(--border-color)';
            resultDiv.style.color = 'var(--text-secondary)';
            resultDiv.innerHTML = 'ğŸ’¾ æ­£åœ¨ä¿å­˜...';
            try {
                const config = {
                    enabled: ((document.getElementById('ai-provider')?.value || 'ollama') === 'thirdparty' ? document.getElementById('global-ai-enabled').checked : false),
                    api_base_url: document.getElementById('thirdparty-api-base-url').value.trim(),
                    api_key: document.getElementById('thirdparty-api-key').value.trim(),
                    model: document.getElementById('thirdparty-model').value.trim(),
                    temperature: parseFloat(document.getElementById('thirdparty-temperature').value),
                    max_tokens: parseInt(document.getElementById('thirdparty-max-tokens').value),
                    system_prompt: document.getElementById('thirdparty-system-prompt').value,
                    ai_name: document.getElementById('thirdparty-ai-name').value.trim() || 'AIåŠ©æ‰‹'
                };
                const response = await fetch('/api/admin/thirdparty-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                const data = await response.json();
                if (data.success) {
                    resultDiv.style.background = 'var(--success-color)';
                    resultDiv.style.border = '1px solid var(--success-color)';
                    resultDiv.style.color = 'white';
                    resultDiv.innerHTML = 'âœ… ç¬¬ä¸‰æ–¹é…ç½®ä¿å­˜æˆåŠŸï¼';
                    setTimeout(() => { resultDiv.style.display = 'none'; }, 3000);
                } else {
                    resultDiv.style.background = 'var(--danger-color)';
                    resultDiv.style.border = '1px solid var(--danger-color)';
                    resultDiv.style.color = 'white';
                    resultDiv.innerHTML = 'âŒ ä¿å­˜å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯');
                }
            } catch (error) {
                resultDiv.style.background = 'var(--danger-color)';
                resultDiv.style.border = '1px solid var(--danger-color)';
                resultDiv.style.color = 'white';
                resultDiv.innerHTML = 'âŒ ä¿å­˜å¤±è´¥: ' + error.message;
            }
        }

        // æµ‹è¯•ç¬¬ä¸‰æ–¹è¿æ¥
        async function testThirdpartyConnection() {
            const resultDiv = document.getElementById('thirdparty-test-result');
            resultDiv.style.display = 'block';
            resultDiv.style.background = 'var(--card-bg)';
            resultDiv.style.border = '1px solid var(--border-color)';
            resultDiv.innerHTML = '<span style="color: var(--text-secondary);">ğŸ” æ­£åœ¨è¿æ¥...</span>';
            try {
                const apiBaseUrl = document.getElementById('thirdparty-api-base-url').value.trim();
                const apiKey = document.getElementById('thirdparty-api-key').value.trim();
                if (!apiBaseUrl || !apiKey) {
                    resultDiv.style.background = 'var(--danger-color)';
                    resultDiv.style.border = '1px solid var(--danger-color)';
                    resultDiv.style.color = 'white';
                    resultDiv.innerHTML = 'âŒ è¯·å¡«å†™ API Base URL ä¸ API Key';
                    return;
                }
                const response = await fetch('/api/admin/thirdparty-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ api_base_url: apiBaseUrl, api_key: apiKey })
                });
                const data = await response.json();
                if (data.success) {
                    resultDiv.style.background = 'var(--success-color)';
                    resultDiv.style.border = '1px solid var(--success-color)';
                    resultDiv.style.color = 'white';
                    const models = (data.models || []).join(', ');
                    resultDiv.innerHTML = 'âœ… ' + data.message + (models ? '<br><small>å¯ç”¨æ¨¡å‹: ' + models + '</small>' : '');
                } else {
                    resultDiv.style.background = 'var(--danger-color)';
                    resultDiv.style.border = '1px solid var(--danger-color)';
                    resultDiv.style.color = 'white';
                    resultDiv.innerHTML = 'âŒ ' + (data.error || 'è¿æ¥å¤±è´¥');
                }
            } catch (error) {
                resultDiv.style.background = 'var(--danger-color)';
                resultDiv.style.border = '1px solid var(--danger-color)';
                resultDiv.style.color = 'white';
                resultDiv.innerHTML = 'âŒ è¿æ¥å¤±è´¥: ' + error.message;
            }
        }

        // æ ¹æ®å½“å‰é»˜è®¤æä¾›æ–¹æ›´æ–°å…¨å±€å¯ç”¨å¼€å…³çŠ¶æ€
        function updateGlobalAIEnabledFromProvider() {
            const provider = document.getElementById('ai-provider')?.value || 'ollama';
            // åˆ‡æ¢æä¾›æ–¹æ—¶ï¼Œé‡æ–°åŠ è½½å¯¹åº”é…ç½®ä»¥åŒæ­¥å…¨å±€å¼€å…³
            if (provider === 'ollama') {
                loadOllamaConfig();
            } else {
                loadThirdpartyConfig();
            }
        }

        // è®¾ç½®å½“å‰é»˜è®¤æä¾›æ–¹çš„å¯ç”¨çŠ¶æ€å¹¶ä¿å­˜
        function setProviderEnabled(enabled) {
            const provider = document.getElementById('ai-provider')?.value || 'ollama';
            if (provider === 'ollama') {
                const o = document.getElementById('ollama-enabled');
                if (o) o.checked = enabled;
                saveOllamaConfig();
            } else {
                saveThirdpartyConfig();
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('room-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // æ–‡ä»¶é¢„è§ˆåŠŸèƒ½
        let currentPreviewFile = '';

        function previewFile(filename, fileType) {
            currentPreviewFile = filename;
            const modal = document.getElementById('preview-modal');
            const content = document.getElementById('preview-content');
            const filenameDisplay = document.getElementById('preview-filename');
            
            filenameDisplay.textContent = filename;
            content.innerHTML = '';
            
            const fileUrl = `/download/${filename}`;
            
            if (fileType === 'image') {
                content.innerHTML = `<img src="${fileUrl}" alt="${filename}">`;
            } else if (fileType === 'video') {
                content.innerHTML = `<video controls autoplay><source src="${fileUrl}">Your browser does not support the video tag.</video>`;
            } else if (fileType === 'audio') {
                content.innerHTML = `<audio controls autoplay><source src="${fileUrl}">Your browser does not support the audio tag.</audio>`;
            } else if (fileType === 'pdf') {
                content.innerHTML = `<iframe src="${fileUrl}"></iframe>`;
            } else if (fileType === 'text') {
                // åŠ è½½æ–‡æœ¬æ–‡ä»¶å†…å®¹
                fetch(fileUrl)
                    .then(response => response.text())
                    .then(text => {
                        content.innerHTML = `<div class="text-preview">${text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>`;
                    })
                    .catch(error => {
                        content.innerHTML = `<div class="text-preview">æ— æ³•åŠ è½½æ–‡æœ¬æ–‡ä»¶</div>`;
                    });
            } else {
                content.innerHTML = `
                    <div class="text-preview" style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“</div>
                        <div style="font-size: 18px; margin-bottom: 10px;">${filename}</div>
                        <div style="color: var(--text-secondary);">æ­¤æ–‡ä»¶ç±»å‹ä¸æ”¯æŒé¢„è§ˆ</div>
                        <button class="btn-save" style="margin-top: 20px;" onclick="window.open('${fileUrl}', '_blank')">ä¸‹è½½æ–‡ä»¶</button>
                    </div>
                `;
            }
            
            modal.classList.add('active');
        }

        function closePreview() {
            const modal = document.getElementById('preview-modal');
            modal.classList.remove('active');
            currentPreviewFile = '';
            // åœæ­¢è§†é¢‘/éŸ³é¢‘æ’­æ”¾
            const content = document.getElementById('preview-content');
            content.innerHTML = '';
        }

        function downloadCurrentFile() {
            if (currentPreviewFile) {
                window.open(`/download/${currentPreviewFile}`, '_blank');
            }
        }

        // ç‚¹å‡»é¢„è§ˆæ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.addEventListener('DOMContentLoaded', function() {
            const previewModal = document.getElementById('preview-modal');
            if (previewModal) {
                previewModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closePreview();
                    }
                });
            }
        });

        // ESCé”®å…³é—­é¢„è§ˆ
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePreview();
            }
        });
    </script>
</body>
</html>
